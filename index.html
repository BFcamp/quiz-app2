<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... (Tu CSS <style> va aqu√≠, sin cambios) ... */
        .opcion-btn { transition: all 0.2s; }
        .opcion-btn:not(.correcto):not(.incorrecto):hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .seleccionada { border: 3px solid #6366f1; }
        .correcta { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .incorrecto { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .hidden-transition { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; }
        .visible-transition { opacity: 1; max-height: 500px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.2); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar-container { width: 100%; background-color: #e0e7ff; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 10px; width: 0%; background-color: #4f46e5; border-radius: 9999px; transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" style="font-family: 'Inter', sans-serif;">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <header class="text-center mb-6 relative">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-700">Quiz App</h1>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-bold p-2 rounded-full"></div>
        </header>

        <div id="loading-screen" class="text-center p-10 bg-indigo-50 rounded-xl">
            <div id="spinner-container" class="mb-4"><div class="spinner mx-auto"></div></div>
            <p id="loading-message" class="text-lg font-medium text-indigo-700 mb-4">Iniciando...</p>
            <div id="progress-container" class="w-full max-w-xs mx-auto hidden"><div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div></div>
        </div>

        <div id="materia-selection-container" class="hidden text-center p-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona una Materia</h2>
            <div class="max-w-sm mx-auto">
                <div id="materia-buttons" class="space-y-4"></div>
                <button id="btn-add-materia" class="mt-6 w-full py-3 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">+ Agregar Nueva Materia</button>
            </div>
        </div>

        <div id="tema-selection-container" class="hidden text-center p-10">
            <button id="btn-volver-materia" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm mb-6">‚Üê Volver a Materias</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona un Tema para <span id="current-materia-name"></span></h2>
            <div id="tema-buttons" class="space-y-4 max-w-sm mx-auto"></div>
            <p id="no-temas-message" class="text-gray-500 mt-6 hidden">No hay temas guardados.</p>
             <button id="btn-go-to-editor" class="mt-8 py-3 px-6 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition w-full">Ir al Editor para Agregar Preguntas</button>
        </div>

        <div class="mb-6 flex justify-between hidden" id="quiz-header-buttons">
             <button id="btn-cambiar-materia" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Cambiar Materia</button>
             <button id="btn-random" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Random üîÄ</button>
             <button id="btn-alternar-vista" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Mostrar Editor</button>
        </div>

        <div id="editor-container" class="hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="quiz-container" class="hidden"> ... (HTML interno sin cambios, aseg√∫rate que btn-siguiente exista) ... </div>
        <div id="resultados-container" class="text-center p-10 hidden"> ... (HTML interno sin cambios, aseg√∫rate que btn-reiniciar exista) ... </div>
        <div id="edit-modal-overlay" class="modal-overlay hidden"> ... (HTML interno sin cambios, aseg√∫rate que btn-save-edit y otros existan) ... </div>

    </div>

    <script type="module">
        // --- CONFIGURACI√ìN DE LA APP ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoKETyeKu3F6vziCMWi8srJAzYv0yrR_ONgSpOpczS23BZ8Ow6eU0uigXRcGlHUuwBiQ/exec";

        // --- VARIABLES DE ESTADO ---
        let MATERIAS = {}; let allQuestionsFromSheet = []; let preguntasMateriaCompleta = [];
        let preguntas = []; let currentMateria = null; let currentTema = null;
        let indicePreguntaActual = 0; let puntaje = 0; let seleccionActual = null;
        let respuestaComprobada = false; let vistaActual = 'quiz'; let isRandomMode = false;

        const MATERIA_COLORS = [ /* ... (lista de colores) ... */
             { color: 'bg-indigo-600', hover: 'hover:bg-indigo-700' }, { color: 'bg-teal-600', hover: 'hover:bg-teal-700' }, { color: 'bg-rose-600', hover: 'hover:bg-rose-700' }, { color: 'bg-amber-600', hover: 'hover:bg-amber-700' }, { color: 'bg-sky-600', hover: 'hover:bg-sky-700' }, { color: 'bg-emerald-600', hover: 'hover:bg-emerald-700' }
        ];

        // --- REFERENCIAS DEL DOM (Declaradas, se asignan en DOMContentLoaded) ---
        let appTitle, loadingScreen, loadingMessage, materiaSelectionContainer, materiaButtons, temaSelectionContainer,
            temaButtons, currentMateriaName, noTemasMessage, quizContainer, resultadosContainer, preguntaTexto,
            opcionesContainer, contadorPregunta, puntajeSpan, totalPreguntasSpan, feedbackContainer, feedbackTexto,
            justificacionBox, justificacionTexto, btnSiguiente, btnReiniciar, resultadoFinal, editorContainer,
            btnAlternarVista, btnCambiarMateria, btnVolverMateria, quizHeaderButtons, editorMateriaNombre,
            editorFeedback, currentTemaName, totalPreguntasEditor, gestionPreguntasContainer, connectionStatus,
            btnGoToEditor, progressContainer, progressBar, spinnerContainer, btnRandom, btnAddMateria,
            editModalOverlay, editPregunta, editTema, editOpcionesContainer, editCorrectaIndex,
            editJustificacion, editQuestionId, btnSaveEdit, btnCancelEdit, btnVerifyIa,
            btnPista, pistaContainer, btnEli5, eli5Container, btnIaGenerate, iaGenerateTopicInput,
            iaGenerateSpinner, iaGenerateText, btnVerifyQuiz, verifyQuizFeedback, btnToggleCargaMasiva,
            cargaMasivaContainer, temaInput, textoPdf, btnAnalizar, analizarText, analizarSpinner,
            temasExistentesDatalist, editFeedbackElement;

        /** Asigna todas las referencias del DOM */
        function assignDomReferences() { /* ... (Sin cambios, asigna todas las variables) ... */ }

        // --- GOOGLE SHEETS Y PERSISTENCIA ---
        function updateConnectionStatus(status, message = '') { /* ... (sin cambios) ... */ }

        // ==========================================
        // == L√ìGICA DE CARGA Y GUARDADO (JSONP) ==
        // ==========================================
        window.handleQuizData = (payload) => { /* ... (sin cambios) ... */ };
        window.handleSaveResult = (payload) => { /* ... (sin cambios) ... */ };
        window.handleJSONPError = (error) => { /* ... (sin cambios) ... */ };
        function loadFromLocalBackup() { /* ... (sin cambios) ... */ }
        async function initApp() { /* ... (sin cambios) ... */ }
        async function saveAllQuestionsToSheet(questionsList) { /* ... (sin cambios) ... */ }

        // --- FUNCIONES DE GESTI√ìN ---
        function renderGestionPreguntas() { /* ... (sin cambios) ... */ }
        function openEditModal(event) {
             // ... (c√≥digo existente para buscar pregunta y rellenar campos) ...
             
             // ¬°Adjunta listeners AQU√ç, cuando el modal se abre!
            if(btnSaveEdit) btnSaveEdit.addEventListener('click', saveEditChanges, { once: true }); // {once: true} evita m√∫ltiples listeners si se abre y cierra r√°pido
            if(btnCancelEdit) btnCancelEdit.addEventListener('click', () => editModalOverlay.classList.add('hidden'), { once: true });
            if(btnVerifyIa) btnVerifyIa.addEventListener('click', () => verifySingleQuestion(false), { once: true });

            editFeedbackElement.classList.add('hidden'); // Usa la variable renombrada
            editModalOverlay.classList.remove('hidden');
        }
        async function saveEditChanges() { /* ... (sin cambios) ... */ }
        async function deleteQuestion(event) { /* ... (sin cambios) ... */ }
        function setEditFeedback(message, isError = false) { /* ... (usa editFeedbackElement) ... */ }

        // --- FUNCIONES DE UTILIDAD PARA VISTAS ---
        function showMateriaSelection() { /* ... (sin cambios) ... */ }
        function selectMateria(materiaId) { /* ... (sin cambios) ... */ }
        function showTemaSelection() { /* ... (sin cambios) ... */ }
        function selectTema(tema) { /* ... (sin cambios) ... */ }
        function alternarVista() { /* ... (sin cambios) ... */ }
        function populateTemaDatalist() { /* ... (sin cambios) ... */ }
        function setFeedback(message, isError = false) { /* ... (sin cambios) ... */ }
        function getUniqueThemes() { /* ... (sin cambios) ... */ }

        // --- FUNCIONES PARA AGREGAR MATERIAS ---
        function generateMateriaId(name) { /* ... (sin cambios) ... */ }
        function addNewMateria() { /* ... (sin cambios, usa JSONP) ... */ }

        // --- FUNCIONES DE ROBUSTEZ Y API ---
        function cleanJsonString(jsonString) { /* ... (sin cambios) ... */ }
        async function fetchWithRetry(url, options, retries = 3) { /* ... (sin cambios) ... */ }

        // --- ‚ú® NUEVAS FUNCIONES DE IA ---
        async function getHint() { /* ... (sin cambios) ... */ }
        async function getELI5Explanation() { /* ... (sin cambios) ... */ }
        async function generateReviewQuestions() { /* ... (sin cambios) ... */ }
        async function verifySingleQuestion(isFromQuiz = false) { /* ... (sin cambios) ... */ }
        async function validateAndRefineQuestions(questions) { /* ... (sin cambios) ... */ }
        async function structurePastedText(rawText, tema) { /* ... (sin cambios) ... */ }
        async function analyzePastedText() { /* ... (sin cambios) ... */ }

        // --- FUNCIONES PRINCIPALES DEL CUESTIONARIO ---
        function cargarPregunta() {
            // ... (c√≥digo existente para resetear UI) ...

            if (preguntas.length === 0 || indicePreguntaActual >= preguntas.length) {
                 // ... (c√≥digo existente para manejar sin preguntas o fin del quiz) ...
                 if (indicePreguntaActual >= preguntas.length && preguntas.length > 0) {
                     mostrarResultados();
                 }
                 return;
            }

            const pregunta = preguntas[indicePreguntaActual];
            // ... (c√≥digo existente para mostrar pregunta y contador) ...

            opcionesContainer.innerHTML = '';
            (pregunta.opciones || []).forEach((opcion, index) => {
                const btn = document.createElement('button');
                btn.textContent = opcion;
                btn.classList.add(/* ... clases ... */);
                btn.dataset.index = index;
                // ¬°Adjunta listener de opci√≥n AQU√ç!
                btn.addEventListener('click', seleccionarOpcion);
                opcionesContainer.appendChild(btn);
            });

            // ¬°Adjunta listener de Pista AQU√ç!
            if (btnPista) btnPista.addEventListener('click', getHint, { once: true });
        }

        function seleccionarOpcion(event) {
             // ... (c√≥digo existente para comprobar respuesta y mostrar feedback) ...

             if (pregunta.justificacion && pregunta.justificacion.trim() !== "") {
                 // ... (c√≥digo existente para mostrar justificaci√≥n) ...
                 // ¬°Adjunta listeners de justificaci√≥n AQU√ç!
                 if (btnEli5) btnEli5.addEventListener('click', getELI5Explanation, { once: true });
                 if (btnVerifyQuiz) btnVerifyQuiz.addEventListener('click', () => verifySingleQuestion(true), { once: true });
                 btnVerifyQuiz.style.display = 'block'; // Asegura que sea visible si hay justificaci√≥n
             } else {
                 if (btnVerifyQuiz) btnVerifyQuiz.style.display = 'none';
             }

            // ¬°Adjunta listener de Siguiente AQU√ç!
            if(btnSiguiente) btnSiguiente.addEventListener('click', siguientePregunta, { once: true }); // Important√≠simo el {once: true} aqu√≠
            btnSiguiente.disabled = false;
            // ... (c√≥digo para cambiar estilo/texto de btnSiguiente) ...
        }

        // --- MANEJO DE VISTAS ---
        function shuffleArray(array) { /* ... (sin cambios) ... */ }
        function toggleRandomMode() { /* ... (sin cambios) ... */ }
        function toggleCargaMasiva() { /* ... (sin cambios) ... */ }
        function siguientePregunta() {
            if (!respuestaComprobada) return;
            indicePreguntaActual++;
            cargarPregunta(); // Esto re-adjuntar√° los listeners necesarios para la nueva pregunta
        }
        function mostrarResultados() {
            // ... (c√≥digo existente para mostrar puntaje) ...
            // ¬°Adjunta listener de Reiniciar AQU√ç!
            if(btnReiniciar) btnReiniciar.addEventListener('click', () => {
                if (isRandomMode && preguntas.length > 0) shuffleArray(preguntas);
                reiniciarCuestionario();
            }, { once: true });
        }
        function reiniciarCuestionario() {
            indicePreguntaActual = 0;
            puntaje = 0;
            if(puntajeSpan) puntajeSpan.textContent = 0;
            if(resultadosContainer) resultadosContainer.classList.add('hidden');
            if(quizContainer) quizContainer.classList.remove('hidden');
            if(quizHeaderButtons) quizHeaderButtons.classList.remove('hidden');
            cargarPregunta(); // Carga la primera pregunta (y adjunta sus listeners)
        }


        // --- INICIO DE LA APLICACI√ìN (CORREGIDO) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado.');
            assignDomReferences(); // Asigna referencias PRIMERO
            console.log('Referencias asignadas.');

            // Adjunta listeners SOLO para elementos SIEMPRE presentes o visibles inicialmente
            console.log('Adjuntando listeners iniciales...');
            if(btnAlternarVista) btnAlternarVista.addEventListener('click', alternarVista); else console.error('btnAlternarVista no encontrado');
            if(btnCambiarMateria) btnCambiarMateria.addEventListener('click', showMateriaSelection); else console.error('btnCambiarMateria no encontrado');
            if(btnVolverMateria) btnVolverMateria.addEventListener('click', showMateriaSelection); else console.error('btnVolverMateria no encontrado');
            if(btnIaGenerate) btnIaGenerate.addEventListener('click', generateReviewQuestions); else console.error('btnIaGenerate no encontrado');
            if(btnToggleCargaMasiva) btnToggleCargaMasiva.addEventListener('click', toggleCargaMasiva); else console.error('btnToggleCargaMasiva no encontrado');
            if(btnAnalizar) btnAnalizar.addEventListener('click', analyzePastedText); else console.error('btnAnalizar no encontrado');
            if(btnGoToEditor) btnGoToEditor.addEventListener('click', () => { if(temaSelectionContainer) temaSelectionContainer.classList.add('hidden'); if(quizHeaderButtons) quizHeaderButtons.classList.remove('hidden'); alternarVista(); }); else console.error('btnGoToEditor no encontrado');
            if(btnRandom) btnRandom.addEventListener('click', toggleRandomMode); else console.error('btnRandom no encontrado');
            if(btnAddMateria) btnAddMateria.addEventListener('click', addNewMateria); else console.error('btnAddMateria no encontrado');
            console.log('Listeners iniciales adjuntados.');

            initApp(); // Llama a initApp para empezar la carga de datos
        });

    </script>
    </body>
</html>
