<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para las opciones de respuesta */
        .opcion-btn { transition: all 0.2s; }
        .opcion-btn:not(.correcto):not(.incorrecto):hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .seleccionada { border: 3px solid #6366f1; }
        .correcta { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .incorrecto { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .hidden-transition { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; }
        .visible-transition { opacity: 1; max-height: 500px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.2); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar-container { width: 100%; background-color: #e0e7ff; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 10px; width: 0%; background-color: #4f46e5; border-radius: 9999px; transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" style="font-family: 'Inter', sans-serif;">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <header class="text-center mb-6 relative">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-700">Quiz App</h1>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-bold p-2 rounded-full"></div>
        </header>

        <div id="loading-screen" class="text-center p-10 bg-indigo-50 rounded-xl">
            <div id="spinner-container" class="mb-4">
                <div class="spinner mx-auto"></div>
            </div>
            <p id="loading-message" class="text-lg font-medium text-indigo-700 mb-4">Iniciando...</p>
            <div id="progress-container" class="w-full max-w-xs mx-auto hidden">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
            </div>
        </div>

        <div id="materia-selection-container" class="hidden text-center p-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona una Materia</h2>
            <div class="max-w-sm mx-auto">
                <div id="materia-buttons" class="space-y-4">
                    </div>
                <button id="btn-add-materia" class="mt-6 w-full py-3 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                    + Agregar Nueva Materia
                </button>
            </div>
        </div>

        <div id="tema-selection-container" class="hidden text-center p-10">
            <button id="btn-volver-materia"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm mb-6">
                ‚Üê Volver a Materias
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona un Tema para <span id="current-materia-name"></span></h2>
            <div id="tema-buttons" class="space-y-4 max-w-sm mx-auto">
                </div>
            <p id="no-temas-message" class="text-gray-500 mt-6 hidden">No hay temas guardados.</p>
             <button id="btn-go-to-editor" class="mt-8 py-3 px-6 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition w-full">
                Ir al Editor para Agregar Preguntas
            </button>
        </div>

        <div class="mb-6 flex justify-between hidden" id="quiz-header-buttons">
             <button id="btn-cambiar-materia"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Cambiar Materia
            </button>
            <button id="btn-random"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Random üîÄ
            </button>
             <button id="btn-alternar-vista"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Mostrar Editor
            </button>
        </div>

        <div id="editor-container" class="hidden">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">Panel de Gesti√≥n (<span id="editor-materia-nombre">Materia</span>)</h2>
            <div class="p-4 border-2 border-dashed border-indigo-300 rounded-lg mb-6 bg-indigo-50">
                 <h3 class="text-xl font-bold text-indigo-700 mb-3">‚ú® Generador de Preguntas con IA</h3>
                 <p class="text-sm text-gray-600 mb-3">¬øNecesitas preguntas para un tema nuevo? Escr√≠belo aqu√≠ y la IA crear√° 3 preguntas para ti.</p>
                 <div class="flex space-x-2">
                     <input type="text" id="ia-generate-topic-input" placeholder="Ej: Intoxicaci√≥n por Plomo" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500">
                     <button id="btn-ia-generate" class="py-3 px-5 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition flex items-center justify-center disabled:bg-gray-400">
                        <span id="ia-generate-text">Generar</span>
                        <div id="ia-generate-spinner" class="spinner ml-2 hidden" style="border-top-color: white;"></div>
                     </button>
                 </div>
            </div>
            <button id="btn-toggle-carga-masiva" class="w-full py-2 mb-4 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200 transition">
                Mostrar/Ocultar Carga Masiva de Texto
            </button>
            <div id="carga-masiva-container" class="p-4 border border-gray-200 rounded-lg mb-6 hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-3">Carga Masiva desde Texto</h3>
                <div class="mb-4">
                     <label for="tema-input" class="block text-sm font-medium text-gray-700 mb-1">Tema a Asignar (Obligatorio)</label>
                     <input type="text" id="tema-input" list="temas-existentes" placeholder="Escribe o selecciona un tema" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500">
                     <datalist id="temas-existentes"></datalist>
                </div>
                <textarea id="texto-pdf" rows="6" placeholder="Pega aqu√≠ el texto sin formato de tus preguntas (Ej: 'Pregunta 1. ¬øAnt√≠doto...? a) Opci√≥n b) Correcta c) Opci√≥n... JUSTIFICACI√ìN: ...') " class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 mb-4"></textarea>
                <button id="btn-analizar" class="w-full py-3 px-6 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="analizar-text">Analizar y Cargar Preguntas</span>
                        <div id="analizar-spinner" class="spinner ml-3 hidden" style="border-top-color: white;"></div>
                </button>
                <p class="text-gray-500 text-xs mt-2 text-center">Esta funci√≥n usa IA para estructurar el texto.</p>
            </div>
            <div id="editor-feedback" class="mb-4 p-3 rounded-lg text-sm hidden"></div>
            <h3 class="text-xl font-bold text-gray-700 my-4 border-t pt-4">Preguntas Guardadas (<span id="total-preguntas-editor">0</span>)</h3>
            <div id="gestion-preguntas-container" class="space-y-3"></div>
        </div>

        <div id="quiz-container" class="hidden">
             <div class="flex justify-between items-center mt-2 mb-4">
                 <p class="text-sm font-semibold text-indigo-700">Tema Actual: <span id="current-tema-name" class="text-indigo-900 font-bold"></span></p>
                 <div id="puntaje-container" class="text-xl font-semibold text-gray-700">Puntaje: <span id="puntaje">0</span> / <span id="total-preguntas">0</span></div>
             </div>
             <div class="bg-indigo-50 p-6 rounded-lg shadow-inner mb-6 transition-all duration-300">
                <div class="flex justify-between items-start">
                    <div>
                        <p id="contador-pregunta" class="text-sm font-medium text-indigo-500 mb-2"></p>
                        <h2 id="pregunta-texto" class="text-xl font-bold text-gray-800">Cargando pregunta...</h2>
                    </div>
                    <button id="btn-pista" class="py-2 px-4 bg-yellow-400 text-yellow-900 text-sm font-semibold rounded-full hover:bg-yellow-500 transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed">Pista ‚ú®</button>
                </div>
                 <div id="pista-container" class="mt-3 p-3 bg-yellow-100 text-yellow-800 text-sm rounded-lg border border-yellow-300 hidden"></div>
             </div>
             <div id="opciones-container" class="space-y-4"></div>
             <div id="feedback-container" class="mt-6 hidden-transition">
                <p id="feedback-texto" class="p-3 rounded-lg text-center font-bold"></p>
                <div id="justificacion-box" class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-300 text-gray-700 text-sm hidden">
                    <div class="flex justify-between items-start">
                        <div>
                             <p class="font-bold text-indigo-600 mb-1">Justificaci√≥n:</p>
                             <p id="justificacion-texto"></p>
                        </div>
                        <div class="flex flex-col space-y-2 ml-4 flex-shrink-0">
                            <button id="btn-eli5" class="py-1 px-3 text-xs bg-teal-400 text-teal-900 font-semibold rounded-full hover:bg-teal-500 transition shadow-sm">Expl√≠camelo F√°cil ‚ú®</button>
                            <button id="btn-verify-quiz" class="py-1 px-3 text-xs bg-yellow-400 text-yellow-900 font-semibold rounded-full hover:bg-yellow-500 transition shadow-sm" style="display: none;">Verificar con IA ‚ú®</button>
                        </div>
                    </div>
                    <div id="eli5-container" class="mt-3 pt-3 border-t border-gray-300 text-sm text-teal-800 hidden"></div>
                    <div id="verify-quiz-feedback" class="mt-2 text-xs text-center font-medium"></div>
                </div>
            </div>
             <div class="mt-8 flex justify-center">
                <button id="btn-siguiente" disabled class="w-full py-3 px-6 bg-gray-300 text-gray-700 font-bold rounded-lg shadow-md hover:bg-gray-400 transition duration-150 ease-in-out disabled:bg-gray-300 disabled:cursor-not-allowed">Siguiente Pregunta</button>
             </div>
        </div>

        <div id="resultados-container" class="text-center p-10 hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-4">¬°Cuestionario Terminado!</h2>
            <p class="text-xl text-gray-600 mb-6">Tu puntaje final es:</p>
            <p id="resultado-final" class="text-6xl font-extrabold text-green-600 mb-8">0/0</p>
            <button id="btn-reiniciar" class="py-3 px-8 bg-indigo-600 text-white font-bold rounded-full shadow-lg hover:bg-indigo-700 transition duration-150 ease-in-out">Volver a Empezar</button>
        </div>
        
        <div id="edit-modal-overlay" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 class="text-2xl font-bold text-indigo-600 mb-4">Editar Pregunta</h3>
                <div class="space-y-4">
                    <input type="hidden" id="edit-question-id">
                    <div><label class="block text-sm font-medium text-gray-700">Pregunta:</label><textarea id="edit-pregunta" rows="3" class="w-full p-2 border rounded-lg"></textarea></div>
                    <div><label class="block text-sm font-medium text-gray-700">Tema:</label><input type="text" id="edit-tema" class="w-full p-2 border rounded-lg" readonly></div>
                    <div id="edit-opciones-container"><label class="block text-sm font-medium text-gray-700">Opciones (Marca Correcta en el selector):</label></div>
                    <div><label class="block text-sm font-medium text-gray-700">√çndice Correcto (0, 1, 2, 3):</label><select id="edit-correcta-index" class="w-full p-2 border rounded-lg"><option value="0">Opci√≥n 1</option><option value="1">Opci√≥n 2</option><option value="2">Opci√≥n 3</option><option value="3">Opci√≥n 4</option></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Justificaci√≥n:</label><textarea id="edit-justificacion" rows="4" class="w-full p-2 border rounded-lg"></textarea></div>
                </div>
                <div id="edit-feedback" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                <div class="flex justify-between mt-6 space-x-3">
                    <button id="btn-verify-ia" class="flex-1 py-2 px-4 bg-yellow-500 text-white font-bold rounded-lg hover:bg-yellow-600 transition disabled:bg-gray-400">‚ú® Verificar con IA</button>
                    <button id="btn-save-edit" class="flex-1 py-2 px-4 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition">Guardar Cambios</button>
                    <button id="btn-cancel-edit" class="py-2 px-4 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400 transition">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // --- CONFIGURACI√ìN DE LA APP ---
        // Pega tu URL de Google Apps Script aqu√≠
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoKETyeKu3F6vziCMWi8srJAzYv0yrR_ONgSpOpczS23BZ8Ow6eU0uigXRcGlHUuwBiQ/exec"; 
        
        // --- VARIABLES DE ESTADO ---
        let MATERIAS = {}; 
        let allQuestionsFromSheet = []; 
        let preguntasMateriaCompleta = [];
        let preguntas = [];
        let currentMateria = null; 
        let currentTema = null; 
        let indicePreguntaActual = 0;
        let puntaje = 0;
        let seleccionActual = null;
        let respuestaComprobada = false;
        let vistaActual = 'quiz'; 
        let isRandomMode = false;

        const MATERIA_COLORS = [ /* ... (lista de colores) ... */
             { color: 'bg-indigo-600', hover: 'hover:bg-indigo-700' }, { color: 'bg-teal-600', hover: 'hover:bg-teal-700' }, { color: 'bg-rose-600', hover: 'hover:bg-rose-700' }, { color: 'bg-amber-600', hover: 'hover:bg-amber-700' }, { color: 'bg-sky-600', hover: 'hover:bg-sky-700' }, { color: 'bg-emerald-600', hover: 'hover:bg-emerald-700' }
        ];

        // --- REFERENCIAS DEL DOM (Declaradas, se asignan en DOMContentLoaded) ---
        let appTitle, loadingScreen, loadingMessage, materiaSelectionContainer, materiaButtons, temaSelectionContainer, 
            temaButtons, currentMateriaName, noTemasMessage, quizContainer, resultadosContainer, preguntaTexto, 
            opcionesContainer, contadorPregunta, puntajeSpan, totalPreguntasSpan, feedbackContainer, feedbackTexto, 
            justificacionBox, justificacionTexto, btnSiguiente, btnReiniciar, resultadoFinal, editorContainer, 
            btnAlternarVista, btnCambiarMateria, btnVolverMateria, quizHeaderButtons, editorMateriaNombre, 
            editorFeedback, currentTemaName, totalPreguntasEditor, gestionPreguntasContainer, connectionStatus, 
            btnGoToEditor, progressContainer, progressBar, spinnerContainer, btnRandom, btnAddMateria, 
            editModalOverlay, editPregunta, editTema, editOpcionesContainer, editCorrectaIndex, 
            editJustificacion, editQuestionId, btnSaveEdit, btnCancelEdit, btnVerifyIa, 
            btnPista, pistaContainer, btnEli5, eli5Container, btnIaGenerate, iaGenerateTopicInput, 
            iaGenerateSpinner, iaGenerateText, btnVerifyQuiz, verifyQuizFeedback, btnToggleCargaMasiva, 
            cargaMasivaContainer, temaInput, textoPdf, btnAnalizar, analizarText, analizarSpinner, 
            temasExistentesDatalist, editFeedbackElement; // Renombrada para evitar conflicto

        /** Asigna todas las referencias del DOM */
        function assignDomReferences() {
            appTitle = document.getElementById('app-title');
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            materiaSelectionContainer = document.getElementById('materia-selection-container');
            materiaButtons = document.getElementById('materia-buttons');
            temaSelectionContainer = document.getElementById('tema-selection-container');
            temaButtons = document.getElementById('tema-buttons');
            currentMateriaName = document.getElementById('current-materia-name');
            noTemasMessage = document.getElementById('no-temas-message');
            quizContainer = document.getElementById('quiz-container');
            resultadosContainer = document.getElementById('resultados-container');
            preguntaTexto = document.getElementById('pregunta-texto');
            opcionesContainer = document.getElementById('opciones-container');
            contadorPregunta = document.getElementById('contador-pregunta');
            puntajeSpan = document.getElementById('puntaje');
            totalPreguntasSpan = document.getElementById('total-preguntas');
            feedbackContainer = document.getElementById('feedback-container');
            feedbackTexto = document.getElementById('feedback-texto');
            justificacionBox = document.getElementById('justificacion-box');
            justificacionTexto = document.getElementById('justificacion-texto');
            btnSiguiente = document.getElementById('btn-siguiente');
            btnReiniciar = document.getElementById('btn-reiniciar');
            resultadoFinal = document.getElementById('resultado-final');
            editorContainer = document.getElementById('editor-container');
            btnAlternarVista = document.getElementById('btn-alternar-vista');
            btnCambiarMateria = document.getElementById('btn-cambiar-materia');
            btnVolverMateria = document.getElementById('btn-volver-materia');
            quizHeaderButtons = document.getElementById('quiz-header-buttons');
            editorMateriaNombre = document.getElementById('editor-materia-nombre');
            editorFeedback = document.getElementById('editor-feedback'); // Para feedback general del editor
            currentTemaName = document.getElementById('current-tema-name');
            totalPreguntasEditor = document.getElementById('total-preguntas-editor');
            gestionPreguntasContainer = document.getElementById('gestion-preguntas-container');
            connectionStatus = document.getElementById('connection-status');
            btnGoToEditor = document.getElementById('btn-go-to-editor');
            progressContainer = document.getElementById('progress-container');
            progressBar = document.getElementById('progress-bar');
            spinnerContainer = document.getElementById('spinner-container');
            btnRandom = document.getElementById('btn-random');
            btnAddMateria = document.getElementById('btn-add-materia');
            editModalOverlay = document.getElementById('edit-modal-overlay');
            editPregunta = document.getElementById('edit-pregunta');
            editTema = document.getElementById('edit-tema');
            editOpcionesContainer = document.getElementById('edit-opciones-container');
            editCorrectaIndex = document.getElementById('edit-correcta-index');
            editJustificacion = document.getElementById('edit-justificacion');
            editQuestionId = document.getElementById('edit-question-id');
            btnSaveEdit = document.getElementById('btn-save-edit');
            btnCancelEdit = document.getElementById('btn-cancel-edit');
            btnVerifyIa = document.getElementById('btn-verify-ia');
            editFeedbackElement = document.getElementById('edit-feedback'); // Feedback espec√≠fico del modal de edici√≥n
            btnPista = document.getElementById('btn-pista');
            pistaContainer = document.getElementById('pista-container');
            btnEli5 = document.getElementById('btn-eli5');
            eli5Container = document.getElementById('eli5-container');
            btnIaGenerate = document.getElementById('btn-ia-generate');
            iaGenerateTopicInput = document.getElementById('ia-generate-topic-input');
            iaGenerateSpinner = document.getElementById('ia-generate-spinner');
            iaGenerateText = document.getElementById('ia-generate-text');
            btnVerifyQuiz = document.getElementById('btn-verify-quiz');
            verifyQuizFeedback = document.getElementById('verify-quiz-feedback');
            btnToggleCargaMasiva = document.getElementById('btn-toggle-carga-masiva');
            cargaMasivaContainer = document.getElementById('carga-masiva-container');
            temaInput = document.getElementById('tema-input');
            textoPdf = document.getElementById('texto-pdf');
            btnAnalizar = document.getElementById('btn-analizar');
            analizarText = document.getElementById('analizar-text');
            analizarSpinner = document.getElementById('analizar-spinner');
            temasExistentesDatalist = document.getElementById('temas-existentes');
        }

        // --- GOOGLE SHEETS Y PERSISTENCIA DE DATOS ---
        function updateConnectionStatus(status, message = '') {
            connectionStatus.classList.remove('bg-yellow-200', 'text-yellow-800', 'bg-green-200', 'text-green-800', 'bg-red-200', 'text-red-800');
            if (status === 'connecting') { connectionStatus.textContent = 'üü° Conectando...'; connectionStatus.classList.add('bg-yellow-200', 'text-yellow-800'); }
            else if (status === 'online') { connectionStatus.textContent = '‚úÖ Sincronizado'; connectionStatus.classList.add('bg-green-200', 'text-green-800'); }
            else if (status === 'offline') { connectionStatus.textContent = '‚ö†Ô∏è Error Conexi√≥n'; connectionStatus.classList.add('bg-red-200', 'text-red-800'); }
        }
        
        // =================================================================
        // == L√ìGICA DE CARGA Y GUARDADO (JSONP) ==
        // =================================================================

        /** CALLBACK DE √âXITO para Carga Inicial */
        window.handleQuizData = (payload) => {
            try {
                if (payload.status === 'error') throw new Error(payload.message);
                MATERIAS = payload.materias || {};
                const rawData = payload.preguntas || [];
                allQuestionsFromSheet = rawData.filter(q => q && q.pregunta && q.materia && q.tema && q.id != null && typeof q.correctaindex === 'number' && Array.isArray(q.opciones) && q.opciones.length > 0);
                localStorage.setItem('quiz_data_backup', JSON.stringify(allQuestionsFromSheet));
                progressBar.style.width = '100%';
                loadingMessage.textContent = `Paso 4: ¬°Encontradas ${allQuestionsFromSheet.length} preguntas y ${Object.keys(MATERIAS).length} materias!`;
                console.log(`Cargadas ${allQuestionsFromSheet.length} preguntas. Materias:`, MATERIAS);
                updateConnectionStatus('online');
                setTimeout(showMateriaSelection, 1200);
            } catch (error) {
                console.error("Error al procesar datos de JSONP:", error);
                loadingMessage.textContent = `Error al procesar datos: ${error.message}`;
                loadFromLocalBackup(); 
            }
        };

        /** CALLBACK DE √âXITO para Guardar Materia */
        window.handleSaveResult = (payload) => {
            const scriptId = 'jsonp-saver-' + Date.now(); // Usa un ID diferente si es necesario
            document.getElementById(scriptId)?.remove(); // Limpia el script tag
            
            // Verifica si el bot√≥n existe antes de intentar modificarlo
            if (btnAddMateria) {
                 btnAddMateria.disabled = false; // Reactiva el bot√≥n
                 btnAddMateria.textContent = "+ Agregar Nueva Materia";
            }

            if (payload.status === 'success') {
                console.log("Materia guardada:", payload.saved_materia);
                MATERIAS[payload.saved_materia.id] = payload.saved_materia;
                showMateriaSelection(); // Refresca la lista de botones
            } else {
                console.error("Error al guardar materia:", payload.message);
                alert(`No se pudo guardar la materia en la nube: ${payload.message}`);
            }
        };

        /** CALLBACK DE ERROR para Carga o Guardado */
        window.handleJSONPError = (error) => {
             console.error("Error en JSONP:", error);
             // Verifica si el bot√≥n existe antes de interactuar
             if (btnAddMateria && btnAddMateria.disabled) { 
                 btnAddMateria.disabled = false;
                 btnAddMateria.textContent = "+ Agregar Nueva Materia";
                 alert("Error de red al intentar guardar la materia. Intenta de nuevo.");
             } else { 
                 loadingMessage.textContent = "Error de red al conectar. Cargando desde guardado local...";
                 loadFromLocalBackup();
             }
        };

        function loadFromLocalBackup() {
            updateConnectionStatus('offline');
            loadingMessage.textContent = "Error de red. Cargando preguntas desde guardado local...";
            MATERIAS = { 'temporal': { name: 'Error de Red', color: 'bg-red-600', hover: 'hover:bg-red-700' } };
            const localData = localStorage.getItem('quiz_data_backup');
            if(localData) {
                allQuestionsFromSheet = JSON.parse(localData);
                loadingMessage.textContent += ` ¬°√âxito! Se cargaron ${allQuestionsFromSheet.length} preguntas del guardado local.`;
            } else {
                loadingMessage.textContent += " No se encontr√≥ un guardado local de preguntas.";
            }
            setTimeout(() => showMateriaSelection(), 2000);
        }

        async function initApp() {
            loadingMessage.textContent = 'Paso 1: Iniciando aplicaci√≥n...';
            updateConnectionStatus('connecting');
            loadingScreen.classList.remove('hidden');
            await new Promise(resolve => setTimeout(resolve, 500));
            try {
                loadingMessage.textContent = 'Paso 2: Conectando con la base de datos...';
                const scriptId = 'jsonp-loader-' + Date.now();
                const script = document.createElement('script');
                const cacheBust = new Date().getTime();
                script.src = `${SCRIPT_URL}?callback=handleQuizData&cachebust=${cacheBust}`; 
                script.id = scriptId;
                script.onerror = handleJSONPError; 
                document.body.appendChild(script);
                loadingMessage.textContent = 'Paso 3: Conexi√≥n exitosa. Buscando datos...';
                spinnerContainer.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '50%';
                script.onload = () => { document.getElementById(scriptId)?.remove(); };
            } catch (error) { handleJSONPError(error); }
        }
        
        // --- FIN L√ìGICA DE CARGA Y GUARDADO ---

        /** FUNCI√ìN saveAllQuestionsToSheet (USA FETCH - Requiere doOptions y CORS en doPost en Code.gs) */
        async function saveAllQuestionsToSheet(questionsList) {
             localStorage.setItem('quiz_data_backup', JSON.stringify(questionsList));
            allQuestionsFromSheet = questionsList;
            if (currentMateria) {
                 preguntasMateriaCompleta = allQuestionsFromSheet.filter(q => q.materia === currentMateria);
                 renderGestionPreguntas();
            }
            updateConnectionStatus('connecting');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveQuestions', data: questionsList })
                });
                // Si llegaste aqu√≠, necesitas asegurarte que tu Code.gs tenga doOptions y que doPost retorne con headers CORS
                if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Error desconocido al guardar en la nube.');
                console.log("Guardado de preguntas confirmado por Google Sheets.");
                updateConnectionStatus('online');
                setFeedback('¬°√âxito! Guardado en la nube y localmente.', false);
                return true;
            } catch (error) {
                console.error("Error al guardar preguntas en la nube:", error);
                setFeedback(`Advertencia: Fall√≥ el guardado en la nube (${error.message}). Tus cambios est√°n seguros localmente.`, true);
                updateConnectionStatus('offline');
                return false;
            }
        }

        // --- FUNCIONES DE GESTI√ìN ---
        function renderGestionPreguntas() { /* ... (sin cambios) ... */ }
        function openEditModal(event) { /* ... (sin cambios) ... */ }
        async function saveEditChanges() { /* ... (sin cambios) ... */ }
        async function deleteQuestion(event) { /* ... (sin cambios) ... */ }
        function setEditFeedback(message, isError = false) { 
            // Usa el elemento correcto para el feedback del modal
            if(editFeedbackElement) {
                editFeedbackElement.textContent = message;
                editFeedbackElement.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                if (isError) { editFeedbackElement.classList.add('bg-red-100', 'text-red-700'); } 
                else { editFeedbackElement.classList.add('bg-green-100', 'text-green-700'); }
            }
        }
        
        // --- FUNCIONES DE UTILIDAD PARA VISTAS ---
        function showMateriaSelection() { /* ... (sin cambios) ... */ }
        function selectMateria(materiaId) { /* ... (sin cambios) ... */ }
        function showTemaSelection() { /* ... (sin cambios) ... */ }
        function selectTema(tema) { /* ... (sin cambios) ... */ }
        function alternarVista() { /* ... (sin cambios) ... */ }
        function populateTemaDatalist() { /* ... (sin cambios) ... */ }
        function setFeedback(message, isError = false) { /* ... (sin cambios, usa editorFeedback global) ... */ }
        function getUniqueThemes() { /* ... (sin cambios) ... */ }

        // --- FUNCIONES PARA AGREGAR MATERIAS (CON GUARDADO JSONP) ---
        function generateMateriaId(name) { /* ... (sin cambios) ... */ }
        function addNewMateria() { /* ... (sin cambios, usa JSONP) ... */ }
        
        // --- FUNCIONES DE ROBUSTEZ Y API ---
        function cleanJsonString(jsonString) { /* ... (sin cambios) ... */ }
        async function fetchWithRetry(url, options, retries = 3) { /* ... (sin cambios) ... */ }
        
        // --- ‚ú® NUEVAS FUNCIONES DE IA (GEMINI API) ‚ú® ---
        async function getHint() { /* ... (sin cambios) ... */ }
        async function getELI5Explanation() { /* ... (sin cambios) ... */ }
        async function generateReviewQuestions() { /* ... (sin cambios) ... */ }
        async function verifySingleQuestion(isFromQuiz = false) { /* ... (sin cambios) ... */ }
        async function validateAndRefineQuestions(questions) { /* ... (sin cambios) ... */ }
        async function structurePastedText(rawText, tema) { /* ... (sin cambios) ... */ }
        async function analyzePastedText() { /* ... (sin cambios) ... */ }

        // --- FUNCIONES PRINCIPALES DEL CUESTIONARIO ---
        function cargarPregunta() { /* ... (sin cambios) ... */ }
        function seleccionarOpcion(event) { /* ... (sin cambios) ... */ }
        
        // --- MANEJO DE VISTAS DEL EDITOR ---
        function shuffleArray(array) { /* ... (sin cambios) ... */ }
        function toggleRandomMode() { /* ... (sin cambios) ... */ }
        function toggleCargaMasiva() { /* ... (sin cambios) ... */ }
        function siguientePregunta() { /* ... (sin cambios) ... */ }
        function mostrarResultados() { /* ... (sin cambios) ... */ }
        function reiniciarCuestionario() { /* ... (sin cambios) ... */ }


        // --- INICIO DE LA APLICACI√ìN (CORREGIDO) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado.');
            
            // 1. Asigna todas las referencias del DOM
            assignDomReferences(); 
            
            // 2. Adjunta todos los listeners (Verifica que todos los elementos existan)
            console.log('Adjuntando listeners...');
            if(btnSiguiente) btnSiguiente.addEventListener('click', siguientePregunta);
            if(btnReiniciar) btnReiniciar.addEventListener('click', () => {
                if (isRandomMode && preguntas.length > 0) shuffleArray(preguntas);
                reiniciarCuestionario();
            });
            if(btnAlternarVista) btnAlternarVista.addEventListener('click', alternarVista);
            if(btnCambiarMateria) btnCambiarMateria.addEventListener('click', showMateriaSelection);
            if(btnVolverMateria) btnVolverMateria.addEventListener('click', showMateriaSelection);
            if(btnCancelEdit) btnCancelEdit.addEventListener('click', () => editModalOverlay.classList.add('hidden'));
            if(btnSaveEdit) btnSaveEdit.addEventListener('click', saveEditChanges);
            if(btnVerifyIa) btnVerifyIa.addEventListener('click', () => verifySingleQuestion(false));
            if(btnVerifyQuiz) btnVerifyQuiz.addEventListener('click', () => verifySingleQuestion(true));
            if(btnPista) btnPista.addEventListener('click', getHint);
            if(btnEli5) btnEli5.addEventListener('click', getELI5Explanation);
            if(btnIaGenerate) btnIaGenerate.addEventListener('click', generateReviewQuestions);
            if(btnToggleCargaMasiva) btnToggleCargaMasiva.addEventListener('click', toggleCargaMasiva);
            if(btnAnalizar) btnAnalizar.addEventListener('click', analyzePastedText);
            if(btnGoToEditor) btnGoToEditor.addEventListener('click', () => {
                temaSelectionContainer.classList.add('hidden');
                quizHeaderButtons.classList.remove('hidden');
                alternarVista();
            });
            if(btnRandom) btnRandom.addEventListener('click', toggleRandomMode);
            if(btnAddMateria) btnAddMateria.addEventListener('click', addNewMateria);
            console.log('Listeners adjuntados.');

            // 3. Llama a initApp para empezar la carga de datos
            initApp(); 
        }); 
        
    </script>
    </body>
</html>
