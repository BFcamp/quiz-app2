<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para las opciones de respuesta */
        .opcion-btn { transition: all 0.2s; }
        .opcion-btn:not(.correcto):not(.incorrecto):hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .seleccionada { border: 3px solid #6366f1; }
        .correcta { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .incorrecto { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .hidden-transition { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; }
        .visible-transition { opacity: 1; max-height: 500px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.2); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar-container { width: 100%; background-color: #e0e7ff; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 10px; width: 0%; background-color: #4f46e5; border-radius: 9999px; transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" style="font-family: 'Inter', sans-serif;">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <header class="text-center mb-6 relative">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-700">Quiz App</h1>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-bold p-2 rounded-full"></div>
        </header>

        <div id="loading-screen" class="text-center p-10 bg-indigo-50 rounded-xl">
            <div id="spinner-container" class="mb-4"><div class="spinner mx-auto"></div></div>
            <p id="loading-message" class="text-lg font-medium text-indigo-700 mb-4">Iniciando...</p>
            <div id="progress-container" class="w-full max-w-xs mx-auto hidden"><div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div></div>
        </div>

        <div id="materia-selection-container" class="hidden text-center p-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona una Materia</h2>
            <div class="max-w-sm mx-auto">
                <div id="materia-buttons" class="space-y-4"></div>
                <button id="btn-add-materia" class="mt-6 w-full py-3 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">+ Agregar Nueva Materia</button>
            </div>
        </div>

        <div id="tema-selection-container" class="hidden text-center p-10">
            <button id="btn-volver-materia" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm mb-6">‚Üê Volver a Materias</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona un Tema para <span id="current-materia-name"></span></h2>
            <div id="tema-buttons" class="space-y-4 max-w-sm mx-auto"></div>
            <p id="no-temas-message" class="text-gray-500 mt-6 hidden">No hay temas guardados.</p>
             <button id="btn-go-to-editor" class="mt-8 py-3 px-6 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition w-full">Ir al Editor para Agregar Preguntas</button>
        </div>

        <div class="mb-6 flex justify-between hidden" id="quiz-header-buttons">
             <button id="btn-cambiar-materia" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Cambiar Materia</button>
             <button id="btn-random" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Random üîÄ</button>
             <button id="btn-alternar-vista" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Mostrar Editor</button>
        </div>

        <div id="editor-container" class="hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="quiz-container" class="hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="resultados-container" class="text-center p-10 hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="edit-modal-overlay" class="modal-overlay hidden"> ... (HTML interno sin cambios) ... </div>

    </div>

    <script type="module">
        // Importa la funci√≥n desde el archivo randomizer.js
        import { shuffleArray } from './randomizer.js';

        // --- CONFIGURACI√ìN DE LA APP ---
        // URL de Google Apps Script proporcionada por el usuario
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoKETyeKu3F6vziCMWi8srJAzYv0yrR_ONgSpOpczS23BZ8Ow6eU0uigXRcGlHUuwBiQ/exec";

        // --- VARIABLES DE ESTADO ---
        let MATERIAS = {}; // Se cargar√° desde Google Script
        let allQuestionsFromSheet = []; let preguntasMateriaCompleta = []; let preguntas = [];
        let currentMateria = null; let currentTema = null; let indicePreguntaActual = 0;
        let puntaje = 0; let seleccionActual = null; let respuestaComprobada = false;
        let vistaActual = 'quiz';
        let isRandomMode = false; // Estado para el bot√≥n Random

        const MATERIA_COLORS = [ /* ... (lista de colores) ... */ ];

        // --- REFERENCIAS DEL DOM (Declaradas, se asignan en DOMContentLoaded) ---
        let appTitle, loadingScreen, loadingMessage, materiaSelectionContainer, materiaButtons, temaSelectionContainer,
            temaButtons, currentMateriaName, noTemasMessage, quizContainer, resultadosContainer, preguntaTexto,
            opcionesContainer, contadorPregunta, puntajeSpan, totalPreguntasSpan, feedbackContainer, feedbackTexto,
            justificacionBox, justificacionTexto, btnSiguiente, btnReiniciar, resultadoFinal, editorContainer,
            btnAlternarVista, btnCambiarMateria, btnVolverMateria, quizHeaderButtons, editorMateriaNombre,
            editorFeedback, currentTemaName, totalPreguntasEditor, gestionPreguntasContainer, connectionStatus,
            btnGoToEditor, progressContainer, progressBar, spinnerContainer, btnRandom, btnAddMateria,
            editModalOverlay, editPregunta, editTema, editOpcionesContainer, editCorrectaIndex,
            editJustificacion, editQuestionId, btnSaveEdit, btnCancelEdit, btnVerifyIa,
            btnPista, pistaContainer, btnEli5, eli5Container, btnIaGenerate, iaGenerateTopicInput,
            iaGenerateSpinner, iaGenerateText, btnVerifyQuiz, verifyQuizFeedback, btnToggleCargaMasiva,
            cargaMasivaContainer, temaInput, textoPdf, btnAnalizar, analizarText, analizarSpinner,
            temasExistentesDatalist, editFeedbackElement;

        /** Asigna todas las referencias del DOM */
        function assignDomReferences() {
            appTitle = document.getElementById('app-title');
            loadingScreen = document.getElementById('loading-screen');
            loadingMessage = document.getElementById('loading-message');
            materiaSelectionContainer = document.getElementById('materia-selection-container');
            materiaButtons = document.getElementById('materia-buttons');
            temaSelectionContainer = document.getElementById('tema-selection-container');
            temaButtons = document.getElementById('tema-buttons');
            currentMateriaName = document.getElementById('current-materia-name');
            noTemasMessage = document.getElementById('no-temas-message');
            quizContainer = document.getElementById('quiz-container');
            resultadosContainer = document.getElementById('resultados-container');
            preguntaTexto = document.getElementById('pregunta-texto');
            opcionesContainer = document.getElementById('opciones-container');
            contadorPregunta = document.getElementById('contador-pregunta');
            puntajeSpan = document.getElementById('puntaje');
            totalPreguntasSpan = document.getElementById('total-preguntas');
            feedbackContainer = document.getElementById('feedback-container');
            feedbackTexto = document.getElementById('feedback-texto');
            justificacionBox = document.getElementById('justificacion-box');
            justificacionTexto = document.getElementById('justificacion-texto');
            btnSiguiente = document.getElementById('btn-siguiente');
            btnReiniciar = document.getElementById('btn-reiniciar');
            resultadoFinal = document.getElementById('resultado-final');
            editorContainer = document.getElementById('editor-container');
            btnAlternarVista = document.getElementById('btn-alternar-vista');
            btnCambiarMateria = document.getElementById('btn-cambiar-materia');
            btnVolverMateria = document.getElementById('btn-volver-materia');
            quizHeaderButtons = document.getElementById('quiz-header-buttons');
            editorMateriaNombre = document.getElementById('editor-materia-nombre');
            editorFeedback = document.getElementById('editor-feedback'); // Feedback general editor
            currentTemaName = document.getElementById('current-tema-name');
            totalPreguntasEditor = document.getElementById('total-preguntas-editor');
            gestionPreguntasContainer = document.getElementById('gestion-preguntas-container');
            connectionStatus = document.getElementById('connection-status');
            btnGoToEditor = document.getElementById('btn-go-to-editor');
            progressContainer = document.getElementById('progress-container');
            progressBar = document.getElementById('progress-bar');
            spinnerContainer = document.getElementById('spinner-container');
            btnRandom = document.getElementById('btn-random');
            btnAddMateria = document.getElementById('btn-add-materia');
            editModalOverlay = document.getElementById('edit-modal-overlay');
            editPregunta = document.getElementById('edit-pregunta');
            editTema = document.getElementById('edit-tema');
            editOpcionesContainer = document.getElementById('edit-opciones-container');
            editCorrectaIndex = document.getElementById('edit-correcta-index');
            editJustificacion = document.getElementById('edit-justificacion');
            editQuestionId = document.getElementById('edit-question-id');
            btnSaveEdit = document.getElementById('btn-save-edit');
            btnCancelEdit = document.getElementById('btn-cancel-edit');
            btnVerifyIa = document.getElementById('btn-verify-ia');
            editFeedbackElement = document.getElementById('edit-feedback'); // Feedback del modal
            btnPista = document.getElementById('btn-pista');
            pistaContainer = document.getElementById('pista-container');
            btnEli5 = document.getElementById('btn-eli5');
            eli5Container = document.getElementById('eli5-container');
            btnIaGenerate = document.getElementById('btn-ia-generate');
            iaGenerateTopicInput = document.getElementById('ia-generate-topic-input');
            iaGenerateSpinner = document.getElementById('ia-generate-spinner');
            iaGenerateText = document.getElementById('ia-generate-text');
            btnVerifyQuiz = document.getElementById('btn-verify-quiz');
            verifyQuizFeedback = document.getElementById('verify-quiz-feedback');
            btnToggleCargaMasiva = document.getElementById('btn-toggle-carga-masiva');
            cargaMasivaContainer = document.getElementById('carga-masiva-container');
            temaInput = document.getElementById('tema-input');
            textoPdf = document.getElementById('texto-pdf');
            btnAnalizar = document.getElementById('btn-analizar');
            analizarText = document.getElementById('analizar-text');
            analizarSpinner = document.getElementById('analizar-spinner');
            temasExistentesDatalist = document.getElementById('temas-existentes');
        }

        // --- GOOGLE SHEETS Y PERSISTENCIA ---
        function updateConnectionStatus(status, message = '') { /* ... (sin cambios) ... */ }

        // ==========================================
        // == L√ìGICA DE CARGA Y GUARDADO (JSONP) ==
        // ==========================================
        window.handleQuizData = (payload) => { /* ... (Usa tu versi√≥n que recibe {materias, preguntas}) ... */ };
        window.handleSaveResult = (payload) => { /* ... (Funci√≥n para manejar el resultado de guardar materia con JSONP) ... */ };
        window.handleJSONPError = (error) => { /* ... (Manejo de errores JSONP) ... */ };
        function loadFromLocalBackup() { /* ... (Carga local si falla la red) ... */ }
        async function initApp() { /* ... (Inicia carga JSONP para {materias, preguntas}) ... */ }
        async function saveAllQuestionsToSheet(questionsList) { /* ... (Usa FETCH para guardar preguntas) ... */ }

        // --- FUNCIONES DE GESTI√ìN ---
        function renderGestionPreguntas() { /* ... */ }
        function openEditModal(event) {
             // ... (c√≥digo existente) ...
             // ¬°Adjunta listeners del modal aqu√≠!
             if(btnSaveEdit) btnSaveEdit.addEventListener('click', saveEditChanges, { once: true });
             if(btnCancelEdit) btnCancelEdit.addEventListener('click', () => { if(editModalOverlay) editModalOverlay.classList.add('hidden'); }, { once: true });
             if(btnVerifyIa) btnVerifyIa.addEventListener('click', () => verifySingleQuestion(false), { once: true });
             // ... (resto del c√≥digo) ...
        }
        async function saveEditChanges() { /* ... */ }
        async function deleteQuestion(event) { /* ... */ }
        function setEditFeedback(message, isError = false) { /* ... */ }

        // --- FUNCIONES DE UTILIDAD PARA VISTAS ---
        function showMateriaSelection() { /* ... */ }
        function selectMateria(materiaId) { /* ... */ }
        function showTemaSelection() { /* ... */ }
        function selectTema(tema) {
            currentTema = tema;
            if(currentTemaName) currentTemaName.textContent = tema;
            if(temaSelectionContainer) temaSelectionContainer.classList.add('hidden');
            if(quizContainer) quizContainer.classList.remove('hidden');
            if(quizHeaderButtons) quizHeaderButtons.classList.remove('hidden');

            preguntas = preguntasMateriaCompleta.filter(p => (p.tema || '').trim() === tema);
            // Solo baraja si el modo random est√° activado
            if (isRandomMode && preguntas.length > 0) {
                 shuffleArray(preguntas); // Llama a la funci√≥n importada
            }
            reiniciarCuestionario();
        }
        function alternarVista() { /* ... */ }
        function populateTemaDatalist() { /* ... */ }
        function setFeedback(message, isError = false) { /* ... */ }
        function getUniqueThemes() { /* ... */ }

        // --- FUNCIONES PARA AGREGAR MATERIAS (CON GUARDADO JSONP) ---
        function generateMateriaId(name) { /* ... */ }
        function addNewMateria() { /* ... (Usar√≠a JSONP para guardar, como en ejemplos anteriores) ... */ }

        // --- FUNCIONES DE ROBUSTEZ Y API ---
        function cleanJsonString(jsonString) { /* ... */ }
        async function fetchWithRetry(url, options, retries = 3) { /* ... */ }

        // --- ‚ú® NUEVAS FUNCIONES DE IA ---
        async function getHint() { /* ... */ }
        async function getELI5Explanation() { /* ... */ }
        async function generateReviewQuestions() { /* ... */ }
        async function verifySingleQuestion(isFromQuiz = false) { /* ... */ }
        async function validateAndRefineQuestions(questions) { /* ... */ }
        async function structurePastedText(rawText, tema) { /* ... */ }
        async function analyzePastedText() { /* ... */ }

        // --- FUNCIONES PRINCIPALES DEL CUESTIONARIO ---
        function cargarPregunta() {
            // ... (c√≥digo reset UI) ...
             if (!preguntaTexto || !contadorPregunta || !totalPreguntasSpan || !opcionesContainer || !btnAlternarVista) {
                console.error("Faltan elementos del DOM en cargarPregunta");
                return;
             }
            if (preguntas.length === 0 || indicePreguntaActual >= preguntas.length) {
                if (indicePreguntaActual >= preguntas.length && preguntas.length > 0) {
                    mostrarResultados();
                } else {
                     preguntaTexto.textContent = `No hay preguntas para "${currentTema}". A√±ade preguntas en el Editor.`;
                     contadorPregunta.textContent = "0 preguntas";
                     totalPreguntasSpan.textContent = "0";
                     opcionesContainer.innerHTML = '';
                     if(btnAlternarVista) btnAlternarVista.textContent = 'Mostrar Editor';
                }
                return;
            }
            // ... (c√≥digo mostrar pregunta) ...
            opcionesContainer.innerHTML = '';
            // ... (forEach para crear botones de opci√≥n y adjuntar listener) ...
             (pregunta.opciones || []).forEach((opcion, index) => {
                 const btn = document.createElement('button');
                 /* ... set text and classes ... */
                 btn.addEventListener('click', seleccionarOpcion);
                 opcionesContainer.appendChild(btn);
             });
             // ¬°Adjunta listener de Pista AQU√ç!
             if (btnPista) btnPista.addEventListener('click', getHint, { once: true });
        }
        function seleccionarOpcion(event) {
             // ... (c√≥digo comprobar respuesta) ...
              if (pregunta.justificacion && pregunta.justificacion.trim() !== "") {
                 // ... (c√≥digo mostrar justificaci√≥n) ...
                 // ¬°Adjunta listeners de justificaci√≥n AQU√ç!
                 if (btnEli5) btnEli5.addEventListener('click', getELI5Explanation, { once: true });
                 if (btnVerifyQuiz) btnVerifyQuiz.addEventListener('click', () => verifySingleQuestion(true), { once: true });
                 if(btnVerifyQuiz) btnVerifyQuiz.style.display = 'block';
             } else {
                 if (btnVerifyQuiz) btnVerifyQuiz.style.display = 'none';
             }
             // ¬°Adjunta listener de Siguiente AQU√ç!
             if(btnSiguiente) {
                 btnSiguiente.removeEventListener('click', siguientePregunta); // Previene duplicados
                 btnSiguiente.addEventListener('click', siguientePregunta, { once: true });
                 btnSiguiente.disabled = false;
                 /* ... update styles ... */
             }
        }

        // --- MANEJO DE VISTAS ---
        // function shuffleArray(array) { /* ... (Eliminada, importada) ... */ }
        function toggleRandomMode() { /* ... (Sin cambios, usa shuffleArray importado) ... */ }
        function toggleCargaMasiva() { /* ... */ }
        function siguientePregunta() { /* ... */ }
        function mostrarResultados() {
             // ... (c√≥digo mostrar puntaje) ...
             // ¬°Adjunta listener de Reiniciar AQU√ç!
             if(btnReiniciar) {
                btnReiniciar.removeEventListener('click', handleReiniciarClick); // Previene duplicados
                btnReiniciar.addEventListener('click', handleReiniciarClick, { once: true });
             }
        }
        // Funci√≥n auxiliar para el listener de reiniciar
        function handleReiniciarClick() {
            if (isRandomMode && preguntas.length > 0) shuffleArray(preguntas);
            reiniciarCuestionario();
        }
        function reiniciarCuestionario() { /* ... (Llama a cargarPregunta) ... */ }


        // --- INICIO DE LA APLICACI√ìN (CORREGIDO) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado.');
            assignDomReferences();
            console.log('Referencias asignadas.');

            console.log('Adjuntando listeners iniciales...');
            // Listeners para elementos siempre presentes
            if(btnAlternarVista) btnAlternarVista.addEventListener('click', alternarVista); else console.error('btnAlternarVista no encontrado');
            if(btnCambiarMateria) btnCambiarMateria.addEventListener('click', showMateriaSelection); else console.error('btnCambiarMateria no encontrado');
            if(btnVolverMateria) btnVolverMateria.addEventListener('click', showMateriaSelection); else console.error('btnVolverMateria no encontrado');
            if(btnIaGenerate) btnIaGenerate.addEventListener('click', generateReviewQuestions); else console.error('btnIaGenerate no encontrado');
            if(btnToggleCargaMasiva) btnToggleCargaMasiva.addEventListener('click', toggleCargaMasiva); else console.error('btnToggleCargaMasiva no encontrado');
            if(btnAnalizar) btnAnalizar.addEventListener('click', analyzePastedText); else console.error('btnAnalizar no encontrado');
            if(btnGoToEditor) btnGoToEditor.addEventListener('click', () => { if(temaSelectionContainer) temaSelectionContainer.classList.add('hidden'); if(quizHeaderButtons) quizHeaderButtons.classList.remove('hidden'); alternarVista(); }); else console.error('btnGoToEditor no encontrado');
            if(btnRandom) btnRandom.addEventListener('click', toggleRandomMode); else console.error('btnRandom no encontrado');
            if(btnAddMateria) btnAddMateria.addEventListener('click', addNewMateria); else console.error('btnAddMateria no encontrado');
            console.log('Listeners iniciales adjuntados.');

            initApp(); // Llama a initApp para empezar la carga
        });

    </script>
    </body>
</html>
