<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para las opciones de respuesta */
        .opcion-btn { transition: all 0.2s; }
        .opcion-btn:not(.correcto):not(.incorrecto):hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .seleccionada { border: 3px solid #6366f1; }
        .correcta { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .incorrecto { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .hidden-transition { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; }
        .visible-transition { opacity: 1; max-height: 500px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.2); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar-container { width: 100%; background-color: #e0e7ff; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 10px; width: 0%; background-color: #4f46e5; border-radius: 9999px; transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" style="font-family: 'Inter', sans-serif;">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <header class="text-center mb-6 relative">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-700">Quiz App</h1>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-bold p-2 rounded-full"></div>
        </header>

        <div id="loading-screen" class="text-center p-10 bg-indigo-50 rounded-xl">
            <div id="spinner-container" class="mb-4"><div class="spinner mx-auto"></div></div>
            <p id="loading-message" class="text-lg font-medium text-indigo-700 mb-4">Iniciando...</p>
            <div id="progress-container" class="w-full max-w-xs mx-auto hidden"><div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div></div>
        </div>

        <div id="materia-selection-container" class="hidden text-center p-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona una Materia</h2>
            <div class="max-w-sm mx-auto">
                <div id="materia-buttons" class="space-y-4"></div>
                <button id="btn-add-materia" class="mt-6 w-full py-3 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">+ Agregar Nueva Materia</button>
            </div>
        </div>

        <div id="tema-selection-container" class="hidden text-center p-10">
            <button id="btn-volver-materia" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm mb-6">‚Üê Volver a Materias</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona un Tema para <span id="current-materia-name"></span></h2>
            <div id="tema-buttons" class="space-y-4 max-w-sm mx-auto"></div>
            <p id="no-temas-message" class="text-gray-500 mt-6 hidden">No hay temas guardados.</p>
             <button id="btn-go-to-editor" class="mt-8 py-3 px-6 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition w-full">Ir al Editor para Agregar Preguntas</button>
        </div>

        <div class="mb-6 flex justify-between hidden" id="quiz-header-buttons">
             <button id="btn-cambiar-materia" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Cambiar Materia</button>
             <button id="btn-random" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Random üîÄ</button>
             <button id="btn-alternar-vista" class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">Mostrar Editor</button>
        </div>

        <div id="editor-container" class="hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="quiz-container" class="hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="resultados-container" class="text-center p-10 hidden"> ... (HTML interno sin cambios) ... </div>
        <div id="edit-modal-overlay" class="modal-overlay hidden"> ... (HTML interno sin cambios) ... </div>

    </div>

    <script type="module">
        // Importa la funci√≥n desde el archivo randomizer.js (aseg√∫rate que exista)
        import { shuffleArray } from './randomizer.js';

        // --- CONFIGURACI√ìN DE LA APP ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoKETyeKu3F6vziCMWi8srJAzYv0yrR_ONgSpOpczS23BZ8Ow6eU0uigXRcGlHUuwBiQ/exec";

        // --- VARIABLES DE ESTADO ---
        let MATERIAS = {}; let allQuestionsFromSheet = []; let preguntasMateriaCompleta = [];
        let preguntas = []; let currentMateria = null; let currentTema = null;
        let indicePreguntaActual = 0; let puntaje = 0; let seleccionActual = null;
        let respuestaComprobada = false; let vistaActual = 'quiz'; let isRandomMode = false;

        const MATERIA_COLORS = [
             { color: 'bg-indigo-600', hover: 'hover:bg-indigo-700' }, { color: 'bg-teal-600', hover: 'hover:bg-teal-700' },
             { color: 'bg-rose-600', hover: 'hover:bg-rose-700' }, { color: 'bg-amber-600', hover: 'hover:bg-amber-700' },
             { color: 'bg-sky-600', hover: 'hover:bg-sky-700' }, { color: 'bg-emerald-600', hover: 'hover:bg-emerald-700' }
        ];

        // --- REFERENCIAS DEL DOM (Declaradas, se asignan en DOMContentLoaded) ---
        let appTitle, loadingScreen, loadingMessage, materiaSelectionContainer, materiaButtons, temaSelectionContainer,
            temaButtons, currentMateriaName, noTemasMessage, quizContainer, resultadosContainer, preguntaTexto,
            opcionesContainer, contadorPregunta, puntajeSpan, totalPreguntasSpan, feedbackContainer, feedbackTexto,
            justificacionBox, justificacionTexto, btnSiguiente, btnReiniciar, resultadoFinal, editorContainer,
            btnAlternarVista, btnCambiarMateria, btnVolverMateria, quizHeaderButtons, editorMateriaNombre,
            editorFeedback, currentTemaName, totalPreguntasEditor, gestionPreguntasContainer, connectionStatus,
            btnGoToEditor, progressContainer, progressBar, spinnerContainer, btnRandom, btnAddMateria,
            editModalOverlay, editPregunta, editTema, editOpcionesContainer, editCorrectaIndex,
            editJustificacion, editQuestionId, btnSaveEdit, btnCancelEdit, btnVerifyIa,
            btnPista, pistaContainer, btnEli5, eli5Container, btnIaGenerate, iaGenerateTopicInput,
            iaGenerateSpinner, iaGenerateText, btnVerifyQuiz, verifyQuizFeedback, btnToggleCargaMasiva,
            cargaMasivaContainer, temaInput, textoPdf, btnAnalizar, analizarText, analizarSpinner,
            temasExistentesDatalist, editFeedbackElement;

        /** Asigna todas las referencias del DOM */
        function assignDomReferences() {
            try {
                appTitle = document.getElementById('app-title');
                loadingScreen = document.getElementById('loading-screen');
                loadingMessage = document.getElementById('loading-message');
                materiaSelectionContainer = document.getElementById('materia-selection-container');
                materiaButtons = document.getElementById('materia-buttons');
                temaSelectionContainer = document.getElementById('tema-selection-container');
                temaButtons = document.getElementById('tema-buttons');
                currentMateriaName = document.getElementById('current-materia-name');
                noTemasMessage = document.getElementById('no-temas-message');
                quizContainer = document.getElementById('quiz-container');
                resultadosContainer = document.getElementById('resultados-container');
                preguntaTexto = document.getElementById('pregunta-texto');
                opcionesContainer = document.getElementById('opciones-container');
                contadorPregunta = document.getElementById('contador-pregunta');
                puntajeSpan = document.getElementById('puntaje');
                totalPreguntasSpan = document.getElementById('total-preguntas');
                feedbackContainer = document.getElementById('feedback-container');
                feedbackTexto = document.getElementById('feedback-texto');
                justificacionBox = document.getElementById('justificacion-box');
                justificacionTexto = document.getElementById('justificacion-texto');
                btnSiguiente = document.getElementById('btn-siguiente');
                btnReiniciar = document.getElementById('btn-reiniciar');
                resultadoFinal = document.getElementById('resultado-final');
                editorContainer = document.getElementById('editor-container');
                btnAlternarVista = document.getElementById('btn-alternar-vista');
                btnCambiarMateria = document.getElementById('btn-cambiar-materia');
                btnVolverMateria = document.getElementById('btn-volver-materia');
                quizHeaderButtons = document.getElementById('quiz-header-buttons');
                editorMateriaNombre = document.getElementById('editor-materia-nombre');
                editorFeedback = document.getElementById('editor-feedback');
                currentTemaName = document.getElementById('current-tema-name');
                totalPreguntasEditor = document.getElementById('total-preguntas-editor');
                gestionPreguntasContainer = document.getElementById('gestion-preguntas-container');
                connectionStatus = document.getElementById('connection-status');
                btnGoToEditor = document.getElementById('btn-go-to-editor');
                progressContainer = document.getElementById('progress-container');
                progressBar = document.getElementById('progress-bar');
                spinnerContainer = document.getElementById('spinner-container');
                btnRandom = document.getElementById('btn-random');
                btnAddMateria = document.getElementById('btn-add-materia');
                editModalOverlay = document.getElementById('edit-modal-overlay');
                editPregunta = document.getElementById('edit-pregunta');
                editTema = document.getElementById('edit-tema');
                editOpcionesContainer = document.getElementById('edit-opciones-container');
                editCorrectaIndex = document.getElementById('edit-correcta-index');
                editJustificacion = document.getElementById('edit-justificacion');
                editQuestionId = document.getElementById('edit-question-id');
                btnSaveEdit = document.getElementById('btn-save-edit');
                btnCancelEdit = document.getElementById('btn-cancel-edit');
                btnVerifyIa = document.getElementById('btn-verify-ia');
                editFeedbackElement = document.getElementById('edit-feedback'); // Asigna al mismo ID que editorFeedback
                btnPista = document.getElementById('btn-pista');
                pistaContainer = document.getElementById('pista-container');
                btnEli5 = document.getElementById('btn-eli5');
                eli5Container = document.getElementById('eli5-container');
                btnIaGenerate = document.getElementById('btn-ia-generate');
                iaGenerateTopicInput = document.getElementById('ia-generate-topic-input');
                iaGenerateSpinner = document.getElementById('ia-generate-spinner');
                iaGenerateText = document.getElementById('ia-generate-text');
                btnVerifyQuiz = document.getElementById('btn-verify-quiz');
                verifyQuizFeedback = document.getElementById('verify-quiz-feedback');
                btnToggleCargaMasiva = document.getElementById('btn-toggle-carga-masiva');
                cargaMasivaContainer = document.getElementById('carga-masiva-container');
                temaInput = document.getElementById('tema-input');
                textoPdf = document.getElementById('texto-pdf');
                btnAnalizar = document.getElementById('btn-analizar');
                analizarText = document.getElementById('analizar-text');
                analizarSpinner = document.getElementById('analizar-spinner');
                temasExistentesDatalist = document.getElementById('temas-existentes');
                console.log("Referencias DOM asignadas.");
            } catch (error) {
                console.error("Error asignando referencias DOM:", error);
                // Muestra un error al usuario si falla la asignaci√≥n inicial
                if(loadingMessage) loadingMessage.textContent = "Error al cargar la interfaz. Recarga la p√°gina.";
                if(loadingScreen && !loadingScreen.classList.contains('hidden')) { // Solo si a√∫n est√° visible
                     if(spinnerContainer) spinnerContainer.classList.add('hidden');
                }
            }
        }


        // --- GOOGLE SHEETS Y PERSISTENCIA ---
        function updateConnectionStatus(status, message = '') { /* ... (sin cambios) ... */ }

        // ==========================================
        // == L√ìGICA DE CARGA Y GUARDADO (JSONP) ==
        // ==========================================
        window.handleQuizData = (payload) => {
             console.log("Recibido handleQuizData:", payload); // Log para depurar
             try {
                if (!payload || payload.status === 'error') throw new Error(payload?.message || 'Respuesta inv√°lida del servidor');
                MATERIAS = payload.materias || {};
                const rawData = payload.preguntas || [];
                allQuestionsFromSheet = rawData.filter(q => q && q.pregunta && q.materia && q.tema && q.id != null && typeof q.correctaindex === 'number' && Array.isArray(q.opciones) && q.opciones.length > 0);
                localStorage.setItem('quiz_data_backup', JSON.stringify(allQuestionsFromSheet));

                if (progressBar) progressBar.style.width = '100%';
                if (loadingMessage) loadingMessage.textContent = `Paso 4: ¬°Encontradas ${allQuestionsFromSheet.length} preguntas y ${Object.keys(MATERIAS).length} materias!`;
                console.log(`Cargadas ${allQuestionsFromSheet.length} preguntas. Materias:`, MATERIAS);
                updateConnectionStatus('online');

                console.log("Datos procesados. Llamando a showMateriaSelection...");
                showMateriaSelection(); // Llama directamente

            } catch (error) {
                console.error("Error al procesar datos de JSONP:", error);
                if (loadingMessage) loadingMessage.textContent = `Error al procesar datos: ${error.message}`;
                loadFromLocalBackup();
            }
        };
        window.handleSaveResult = (payload) => {
            console.log("Recibido handleSaveResult:", payload); // Log para depurar
             document.querySelectorAll('script[id^="jsonp-saver-"]').forEach(script => script.remove());

            if (btnAddMateria) {
                 btnAddMateria.disabled = false;
                 btnAddMateria.textContent = "+ Agregar Nueva Materia";
            }

            if (payload && payload.status === 'success') {
                console.log("Materia guardada:", payload.saved_materia);
                MATERIAS[payload.saved_materia.id] = payload.saved_materia;
                showMateriaSelection();
            } else {
                console.error("Error al guardar materia:", payload?.message || 'Respuesta inv√°lida');
                alert(`No se pudo guardar la materia en la nube: ${payload?.message || 'Respuesta inv√°lida'}`);
            }
        };
        window.handleJSONPError = (error) => {
            console.error("Error en JSONP (onerror):", error);
            document.querySelectorAll('script[id^="jsonp-"]').forEach(script => script.remove());

             if (btnAddMateria && btnAddMateria.disabled) {
                 btnAddMateria.disabled = false;
                 btnAddMateria.textContent = "+ Agregar Nueva Materia";
                 alert("Error de red al intentar guardar la materia. Intenta de nuevo.");
             } else {
                 if(loadingMessage) loadingMessage.textContent = "Error de red al conectar. Cargando desde guardado local...";
                 loadFromLocalBackup();
             }
        };
        function loadFromLocalBackup() { /* ... (sin cambios) ... */ }
        async function initApp() {
            if(loadingMessage) loadingMessage.textContent = 'Paso 1: Iniciando aplicaci√≥n...';
            updateConnectionStatus('connecting');
            if(loadingScreen) loadingScreen.classList.remove('hidden');
            await new Promise(resolve => setTimeout(resolve, 100));
            try {
                if(loadingMessage) loadingMessage.textContent = 'Paso 2: Conectando con la base de datos...';
                const scriptId = 'jsonp-loader-' + Date.now();
                const script = document.createElement('script');
                const cacheBust = new Date().getTime();
                script.src = `${SCRIPT_URL}?callback=handleQuizData&cachebust=${cacheBust}`;
                script.id = scriptId;
                script.onerror = handleJSONPError;
                document.body.appendChild(script);
                if(loadingMessage) loadingMessage.textContent = 'Paso 3: Esperando respuesta del servidor...';
                if(spinnerContainer) spinnerContainer.classList.remove('hidden');
                if(progressContainer) progressContainer.classList.add('hidden');

                // Timeout
                setTimeout(() => {
                    if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                         console.warn("Timeout esperando respuesta del script. Forzando manejo de error.");
                         handleJSONPError("Timeout");
                         // Intenta remover el script si a√∫n existe
                         document.getElementById(scriptId)?.remove();
                    }
                }, 15000); // 15 segundos

                script.onload = () => { document.getElementById(scriptId)?.remove(); };

            } catch (error) { handleJSONPError(error); }
         }

        // --- FIN L√ìGICA DE CARGA Y GUARDADO ---

        /** FUNCI√ìN saveAllQuestionsToSheet (USA FETCH - Requiere doOptions y CORS en doPost en Code.gs) */
        async function saveAllQuestionsToSheet(questionsList) { /* ... (sin cambios) ... */ }

        // --- FUNCIONES DE GESTI√ìN ---
        function renderGestionPreguntas() { /* ... (sin cambios) ... */ }
        function openEditModal(event) {
            const questionId = parseFloat(event.target.dataset.id);
            const question = allQuestionsFromSheet.find(q => q.id === questionId);
            if (!question) { /* ... manejo de error ... */ return; }
            /* ... rellenar campos ... */
            // ¬°Adjunta listeners AQU√ç!
            if(btnSaveEdit) btnSaveEdit.addEventListener('click', saveEditChanges, { once: true });
            if(btnCancelEdit) btnCancelEdit.addEventListener('click', () => { if(editModalOverlay) editModalOverlay.classList.add('hidden'); }, { once: true });
            if(btnVerifyIa) btnVerifyIa.addEventListener('click', () => verifySingleQuestion(false), { once: true });
            if(editFeedbackElement) editFeedbackElement.classList.add('hidden');
            if(editModalOverlay) editModalOverlay.classList.remove('hidden');
        }
        async function saveEditChanges() { /* ... (sin cambios) ... */ }
        async function deleteQuestion(event) { /* ... (sin cambios) ... */ }
        function setEditFeedback(message, isError = false) { /* ... (usa editFeedbackElement) ... */ }

        // --- FUNCIONES DE UTILIDAD PARA VISTAS ---
        function showMateriaSelection() {
             console.log("Dentro de showMateriaSelection.");
             if(loadingScreen) loadingScreen.classList.add('hidden');
             // ... (resto de ocultar/mostrar divs) ...
             if(materiaSelectionContainer) materiaSelectionContainer.classList.remove('hidden');
             // ... (c√≥digo para crear botones de materia) ...
        }
        function selectMateria(materiaId) { /* ... (sin cambios) ... */ }
        function showTemaSelection() { /* ... (sin cambios) ... */ }
        function selectTema(tema) { /* ... (usa shuffleArray importado) ... */ }
        function alternarVista() {
            // Mueve listeners del editor aqu√≠
            if (vistaActual === 'quiz') {
                // ... (c√≥digo para mostrar editor) ...
                console.log('Adjuntando listeners del editor...');
                // Usa {once: false} si quieres que funcionen cada vez que se abre
                if(btnIaGenerate) btnIaGenerate.addEventListener('click', generateReviewQuestions);
                if(btnToggleCargaMasiva) btnToggleCargaMasiva.addEventListener('click', toggleCargaMasiva);
                if(btnAnalizar) btnAnalizar.addEventListener('click', analyzePastedText);
            } else {
                // ... (c√≥digo para mostrar quiz) ...
                 // Podr√≠as remover los listeners del editor aqu√≠ si usaste {once: false}
            }
        }
        function populateTemaDatalist() { /* ... (sin cambios) ... */ }
        function setFeedback(message, isError = false) { /* ... (sin cambios) ... */ }
        function getUniqueThemes() { /* ... (sin cambios) ... */ }

        // --- FUNCIONES PARA AGREGAR MATERIAS (CON GUARDADO JSONP) ---
        function generateMateriaId(name) { /* ... (sin cambios) ... */ }
        function addNewMateria() { /* ... (usa JSONP y handleSaveResult) ... */ }

        // --- FUNCIONES DE ROBUSTEZ Y API ---
        function cleanJsonString(jsonString) { /* ... (sin cambios) ... */ }
        async function fetchWithRetry(url, options, retries = 3) { /* ... (sin cambios) ... */ }

        // --- ‚ú® NUEVAS FUNCIONES DE IA ---
        async function getHint() { /* ... (Adjuntar listener en cargarPregunta) ... */ }
        async function getELI5Explanation() { /* ... (Adjuntar listener en seleccionarOpcion) ... */ }
        async function generateReviewQuestions() { /* ... (Listener adjunto en alternarVista) ... */ }
        async function verifySingleQuestion(isFromQuiz = false) { /* ... (Listeners adjuntos en openEditModal y seleccionarOpcion) ... */ }
        async function validateAndRefineQuestions(questions) { /* ... */ }
        async function structurePastedText(rawText, tema) { /* ... */ }
        async function analyzePastedText() { /* ... (Listener adjunto en alternarVista) ... */ }

        // --- FUNCIONES PRINCIPALES DEL CUESTIONARIO ---
        function cargarPregunta() {
             // ... (c√≥digo reset UI y manejo sin preguntas) ...
             // Adjunta listeners para ESTA pregunta
             if (btnPista) btnPista.addEventListener('click', getHint, { once: true });
             // ... (c√≥digo crear botones opci√≥n y adjuntar su listener) ...
             (pregunta.opciones || []).forEach((opcion, index) => {
                 const btn = document.createElement('button');
                 /* ... set text and classes ... */
                 btn.addEventListener('click', seleccionarOpcion); // Este se adjunta por cada opci√≥n
                 opcionesContainer.appendChild(btn);
             });
        }
        function seleccionarOpcion(event) {
             // ... (c√≥digo comprobar respuesta y mostrar feedback) ...
             if (pregunta.justificacion && pregunta.justificacion.trim() !== "") {
                 // ... (mostrar justificaci√≥n) ...
                 // Adjunta listeners justificaci√≥n
                 if (btnEli5) btnEli5.addEventListener('click', getELI5Explanation, { once: true });
                 if (btnVerifyQuiz) btnVerifyQuiz.addEventListener('click', () => verifySingleQuestion(true), { once: true });
                 /* ... mostrar btnVerifyQuiz ... */
             }
             // Adjunta listener Siguiente (importante remover el anterior si existe)
             if(btnSiguiente) {
                 // Clona y reemplaza para remover listeners previos de forma segura
                 const newBtnSiguiente = btnSiguiente.cloneNode(true);
                 btnSiguiente.parentNode.replaceChild(newBtnSiguiente, btnSiguiente);
                 btnSiguiente = newBtnSiguiente; // Actualiza la referencia
                 btnSiguiente.addEventListener('click', siguientePregunta, { once: true });
                 btnSiguiente.disabled = false;
                 /* ... update styles ... */
             }
        }

        // --- MANEJO DE VISTAS ---
        // function shuffleArray(array) { /* ... (Importada) ... */ }
        function toggleRandomMode() { /* ... (usa shuffleArray importado) ... */ }
        function toggleCargaMasiva() { /* ... (Listener adjunto en alternarVista) ... */ }
        function siguientePregunta() {
            if (!respuestaComprobada) return;
            indicePreguntaActual++;
            cargarPregunta(); // Carga la siguiente pregunta y sus listeners
        }
        function mostrarResultados() {
             // ... (c√≥digo mostrar puntaje) ...
             // Adjunta listener Reiniciar (removiendo el anterior)
             if(btnReiniciar) {
                 const newBtnReiniciar = btnReiniciar.cloneNode(true);
                 btnReiniciar.parentNode.replaceChild(newBtnReiniciar, btnReiniciar);
                 btnReiniciar = newBtnReiniciar; // Actualiza referencia
                 btnReiniciar.addEventListener('click', handleReiniciarClick, { once: true });
             }
        }
        function handleReiniciarClick() { /* ... (llama a reiniciarCuestionario) ... */ }
        function reiniciarCuestionario() { /* ... (llama a cargarPregunta) ... */ }


        // --- INICIO DE LA APLICACI√ìN (CORREGIDO) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM cargado.');
            assignDomReferences();
            console.log('Referencias asignadas.');

            console.log('Adjuntando listeners iniciales...');
            // Listeners para elementos siempre presentes
            if(btnAlternarVista) btnAlternarVista.addEventListener('click', alternarVista); else console.error('btnAlternarVista no encontrado');
            if(btnCambiarMateria) btnCambiarMateria.addEventListener('click', showMateriaSelection); else console.error('btnCambiarMateria no encontrado');
            if(btnVolverMateria) btnVolverMateria.addEventListener('click', showMateriaSelection); else console.error('btnVolverMateria no encontrado');
            if(btnGoToEditor) btnGoToEditor.addEventListener('click', () => { if(temaSelectionContainer) temaSelectionContainer.classList.add('hidden'); if(quizHeaderButtons) quizHeaderButtons.classList.remove('hidden'); alternarVista(); }); else console.error('btnGoToEditor no encontrado');
            if(btnRandom) btnRandom.addEventListener('click', toggleRandomMode); else console.error('btnRandom no encontrado');
            if(btnAddMateria) btnAddMateria.addEventListener('click', addNewMateria); else console.error('btnAddMateria no encontrado');
             // Nota: Los listeners para btnIaGenerate, btnToggleCargaMasiva, btnAnalizar se mueven a alternarVista
             // Nota: Los listeners para btnSiguiente, btnReiniciar, btnPista, etc., se mueven a sus funciones respectivas
            console.log('Listeners iniciales adjuntados.');

            initApp(); // Llama a initApp para empezar la carga de datos
        });

    </script>
    </body>
</html>
