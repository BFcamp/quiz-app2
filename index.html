<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... (Tu CSS <style> va aqu√≠, sin cambios) ... */
        .opcion-btn { transition: all 0.2s; }
        .opcion-btn:not(.correcto):not(.incorrecto):hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .seleccionada { border: 3px solid #6366f1; }
        .correcta { background-color: #10b981 !important; color: white !important; border-color: #059669 !important; }
        .incorrecto { background-color: #ef4444 !important; color: white !important; border-color: #dc2626 !important; }
        .hidden-transition { opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease-out, max-height 0.3s ease-out; }
        .visible-transition { opacity: 1; max-height: 500px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.2); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 24px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar-container { width: 100%; background-color: #e0e7ff; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 10px; width: 0%; background-color: #4f46e5; border-radius: 9999px; transition: width 1s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4" style="font-family: 'Inter', sans-serif;">

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <header class="text-center mb-6 relative">
            <h1 id="app-title" class="text-3xl font-extrabold text-indigo-700">Quiz App</h1>
            <div id="connection-status" class="absolute top-0 right-0 text-xs font-bold p-2 rounded-full"></div>
        </header>

        <div id="loading-screen" class="text-center p-10 bg-indigo-50 rounded-xl">
            <div id="spinner-container" class="mb-4">
                <div class="spinner mx-auto"></div>
            </div>
            <p id="loading-message" class="text-lg font-medium text-indigo-700 mb-4">Iniciando...</p>
            <div id="progress-container" class="w-full max-w-xs mx-auto hidden">
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
            </div>
        </div>

       <div id="materia-selection-container" class="hidden text-center p-10">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona una Materia</h2>

            <div class="max-w-sm mx-auto">
                <div id="materia-buttons" class="space-y-4">
                    </div>

                <button id="btn-add-materia" class="mt-6 w-full py-3 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                    + Agregar Nueva Materia
                </button>
                </div>

        </div>

        <div id="tema-selection-container" class="hidden text-center p-10">
            <button id="btn-volver-materia"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm mb-6">
                ‚Üê Volver a Materias
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Selecciona un Tema para <span id="current-materia-name"></span></h2>
            <div id="tema-buttons" class="space-y-4 max-w-sm mx-auto">
                </div>
            <p id="no-temas-message" class="text-gray-500 mt-6 hidden">No hay temas guardados.</p>
             <button id="btn-go-to-editor" class="mt-8 py-3 px-6 bg-gray-700 text-white font-bold rounded-lg shadow-md hover:bg-gray-800 transition w-full">
                Ir al Editor para Agregar Preguntas
            </button>
        </div>

        <div class="mb-6 flex justify-between hidden" id="quiz-header-buttons">
             <button id="btn-cambiar-materia"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Cambiar Materia
            </button>
            <button id="btn-random"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Random üîÄ
            </button>
             <button id="btn-alternar-vista"
                    class="py-2 px-4 text-sm bg-gray-200 text-gray-700 font-medium rounded-full hover:bg-gray-300 transition duration-150 ease-in-out shadow-sm">
                Mostrar Editor
            </button>
        </div>

        <div id="editor-container" class="hidden"> ... </div>
        <div id="quiz-container" class="hidden"> ... </div>
        <div id="resultados-container" class="text-center p-10 hidden"> ... </div>
        <div id="edit-modal-overlay" class="modal-overlay hidden"> ... </div>

    </div>

    <script type="module">
        // --- CONFIGURACI√ìN DE LA APP ---
        // ¬°¬°¬°ASEG√öRATE DE PEGAR TU NUEVA URL AQU√ç!!!
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxoKETyeKu3F6vziCMWi8srJAzYv0yrR_ONgSpOpczS23BZ8Ow6eU0uigXRcGlHUuwBiQ/exec"; 
        
        // --- VARIABLES DE ESTADO ---
        let MATERIAS = {}; 
        let allQuestionsFromSheet = []; 
        let preguntasMateriaCompleta = [];
        let preguntas = [];
        let currentMateria = null; 
        let currentTema = null; 
        let indicePreguntaActual = 0;
        let puntaje = 0;
        let seleccionActual = null;
        let respuestaComprobada = false;
        let vistaActual = 'quiz'; 
        let isRandomMode = false;

        const MATERIA_COLORS = [ /* ... (lista de colores sin cambios) ... */
             { color: 'bg-indigo-600', hover: 'hover:bg-indigo-700' }, { color: 'bg-teal-600', hover: 'hover:bg-teal-700' }, { color: 'bg-rose-600', hover: 'hover:bg-rose-700' }, { color: 'bg-amber-600', hover: 'hover:bg-amber-700' }, { color: 'bg-sky-600', hover: 'hover:bg-sky-700' }, { color: 'bg-emerald-600', hover: 'hover:bg-emerald-700' }
        ];

        // --- REFERENCIAS DEL DOM ---
        // (Sin cambios, aseg√∫rate de tener todas las referencias)
        const appTitle = document.getElementById('app-title');
        const loadingScreen = document.getElementById('loading-screen');
        const loadingMessage = document.getElementById('loading-message');
        const materiaSelectionContainer = document.getElementById('materia-selection-container');
        const materiaButtons = document.getElementById('materia-buttons');
        const temaSelectionContainer = document.getElementById('tema-selection-container');
        // ... (todas las dem√°s referencias) ...
        const btnAddMateria = document.getElementById('btn-add-materia');
        const btnRandom = document.getElementById('btn-random');
        // ... (y el resto de referencias) ...
        const btnGoToEditor = document.getElementById('btn-go-to-editor');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const spinnerContainer = document.getElementById('spinner-container');
        // ... (y todas las dem√°s) ...
        const temasExistentesDatalist = document.getElementById('temas-existentes');
        const connectionStatus = document.getElementById('connection-status');
        const btnCambiarMateria = document.getElementById('btn-cambiar-materia');
        const btnAlternarVista = document.getElementById('btn-alternar-vista');
        const quizHeaderButtons = document.getElementById('quiz-header-buttons');
        const currentMateriaName = document.getElementById('current-materia-name');
        const editorMateriaNombre = document.getElementById('editor-materia-nombre');
        const btnVolverMateria = document.getElementById('btn-volver-materia');
        const temaButtons = document.getElementById('tema-buttons');
        const noTemasMessage = document.getElementById('no-temas-message');
        const quizContainer = document.getElementById('quiz-container');
        const currentTemaName = document.getElementById('current-tema-name');
        const puntajeSpan = document.getElementById('puntaje');
        const totalPreguntasSpan = document.getElementById('total-preguntas');
        const contadorPregunta = document.getElementById('contador-pregunta');
        const preguntaTexto = document.getElementById('pregunta-texto');
        const btnPista = document.getElementById('btn-pista');
        const pistaContainer = document.getElementById('pista-container');
        const opcionesContainer = document.getElementById('opciones-container');
        const feedbackContainer = document.getElementById('feedback-container');
        const feedbackTexto = document.getElementById('feedback-texto');
        const justificacionBox = document.getElementById('justificacion-box');
        const justificacionTexto = document.getElementById('justificacion-texto');
        const btnEli5 = document.getElementById('btn-eli5');
        const btnVerifyQuiz = document.getElementById('btn-verify-quiz');
        const eli5Container = document.getElementById('eli5-container');
        const verifyQuizFeedback = document.getElementById('verify-quiz-feedback');
        const btnSiguiente = document.getElementById('btn-siguiente');
        const resultadosContainer = document.getElementById('resultados-container');
        const resultadoFinal = document.getElementById('resultado-final');
        const btnReiniciar = document.getElementById('btn-reiniciar');
        const editorContainer = document.getElementById('editor-container');
        const iaGenerateTopicInput = document.getElementById('ia-generate-topic-input');
        const btnIaGenerate = document.getElementById('btn-ia-generate');
        const iaGenerateText = document.getElementById('ia-generate-text');
        const iaGenerateSpinner = document.getElementById('ia-generate-spinner');
        const btnToggleCargaMasiva = document.getElementById('btn-toggle-carga-masiva');
        const cargaMasivaContainer = document.getElementById('carga-masiva-container');
        const temaInput = document.getElementById('tema-input');
        const textoPdf = document.getElementById('texto-pdf');
        const btnAnalizar = document.getElementById('btn-analizar');
        const analizarText = document.getElementById('analizar-text');
        const analizarSpinner = document.getElementById('analizar-spinner');
        const editorFeedback = document.getElementById('editor-feedback');
        const totalPreguntasEditor = document.getElementById('total-preguntas-editor');
        const gestionPreguntasContainer = document.getElementById('gestion-preguntas-container');
        const editModalOverlay = document.getElementById('edit-modal-overlay');
        const editQuestionId = document.getElementById('edit-question-id');
        const editPregunta = document.getElementById('edit-pregunta');
        const editTema = document.getElementById('edit-tema');
        const editOpcionesContainer = document.getElementById('edit-opciones-container');
        const editCorrectaIndex = document.getElementById('edit-correcta-index');
        const editJustificacion = document.getElementById('edit-justificacion');
        const editFeedback = document.getElementById('edit-feedback');
        const btnVerifyIa = document.getElementById('btn-verify-ia');
        const btnSaveEdit = document.getElementById('btn-save-edit');
        const btnCancelEdit = document.getElementById('btn-cancel-edit');


        // --- GOOGLE SHEETS Y PERSISTENCIA DE DATOS ---
        function updateConnectionStatus(status, message = '') {
            // ... (funci√≥n sin cambios) ...
             connectionStatus.classList.remove('bg-yellow-200', 'text-yellow-800', 'bg-green-200', 'text-green-800', 'bg-red-200', 'text-red-800');
            if (status === 'connecting') { connectionStatus.textContent = 'üü° Conectando...'; connectionStatus.classList.add('bg-yellow-200', 'text-yellow-800'); }
            else if (status === 'online') { connectionStatus.textContent = '‚úÖ Sincronizado'; connectionStatus.classList.add('bg-green-200', 'text-green-800'); }
            else if (status === 'offline') { connectionStatus.textContent = '‚ö†Ô∏è Error Conexi√≥n'; connectionStatus.classList.add('bg-red-200', 'text-red-800'); }
        }
        
        // =================================================================
        // == L√ìGICA DE CARGA Y GUARDADO (JSONP) ==
        // =================================================================

        /** CALLBACK DE √âXITO para Carga Inicial (doGet sin action) */
        window.handleQuizData = (payload) => {
            try {
                if (payload.status === 'error') throw new Error(payload.message);
                MATERIAS = payload.materias || {};
                const rawData = payload.preguntas || [];
                allQuestionsFromSheet = rawData.filter(q => q && q.pregunta && q.materia && q.tema && q.id != null && typeof q.correctaindex === 'number' && Array.isArray(q.opciones) && q.opciones.length > 0);
                localStorage.setItem('quiz_data_backup', JSON.stringify(allQuestionsFromSheet));
                progressBar.style.width = '100%';
                loadingMessage.textContent = `Paso 4: ¬°Encontradas ${allQuestionsFromSheet.length} preguntas y ${Object.keys(MATERIAS).length} materias!`;
                console.log(`Cargadas ${allQuestionsFromSheet.length} preguntas. Materias:`, MATERIAS);
                updateConnectionStatus('online');
                setTimeout(showMateriaSelection, 1200);
            } catch (error) {
                console.error("Error al procesar datos de JSONP:", error);
                loadingMessage.textContent = `Error al procesar datos: ${error.message}`;
                loadFromLocalBackup(); 
            }
        };

        /** CALLBACK DE √âXITO para Guardar Materia (doGet con action=addMateria) */
        window.handleSaveResult = (payload) => {
            const scriptId = 'jsonp-saver-' + Date.now(); // Usa un ID diferente si es necesario
            document.getElementById(scriptId)?.remove(); // Limpia el script tag
            
            btnAddMateria.disabled = false; // Reactiva el bot√≥n
            btnAddMateria.textContent = "+ Agregar Nueva Materia";

            if (payload.status === 'success') {
                console.log("Materia guardada:", payload.saved_materia);
                // Actualiza el estado local y la UI
                MATERIAS[payload.saved_materia.id] = payload.saved_materia;
                showMateriaSelection(); // Refresca la lista de botones
            } else {
                console.error("Error al guardar materia:", payload.message);
                alert(`No se pudo guardar la materia en la nube: ${payload.message}`);
            }
        };

        /** CALLBACK DE ERROR para Carga o Guardado */
        window.handleJSONPError = (error) => {
             console.error("Error en JSONP:", error);
             // Si falla el guardado, informa al usuario
             if (btnAddMateria.disabled) { // Si el bot√≥n de guardar est√° deshabilitado, fue un error de guardado
                 btnAddMateria.disabled = false;
                 btnAddMateria.textContent = "+ Agregar Nueva Materia";
                 alert("Error de red al intentar guardar la materia. Intenta de nuevo.");
             } else { // Si no, fue un error de carga inicial
                 loadingMessage.textContent = "Error de red al conectar. Cargando desde guardado local...";
                 loadFromLocalBackup();
             }
        };

        function loadFromLocalBackup() {
            // ... (funci√≥n sin cambios) ...
            updateConnectionStatus('offline');
            loadingMessage.textContent = "Error de red. Cargando preguntas desde guardado local...";
            MATERIAS = { 'temporal': { name: 'Error de Red', color: 'bg-red-600', hover: 'hover:bg-red-700' } };
            const localData = localStorage.getItem('quiz_data_backup');
            if(localData) {
                allQuestionsFromSheet = JSON.parse(localData);
                loadingMessage.textContent += ` ¬°√âxito! Se cargaron ${allQuestionsFromSheet.length} preguntas del guardado local.`;
            } else {
                loadingMessage.textContent += " No se encontr√≥ un guardado local de preguntas.";
            }
            setTimeout(() => showMateriaSelection(), 2000);
        }

        async function initApp() {
            // ... (funci√≥n sin cambios, usa JSONP para cargar) ...
            loadingMessage.textContent = 'Paso 1: Iniciando aplicaci√≥n...';
            updateConnectionStatus('connecting');
            loadingScreen.classList.remove('hidden');
            await new Promise(resolve => setTimeout(resolve, 500));
            try {
                loadingMessage.textContent = 'Paso 2: Conectando con la base de datos...';
                const scriptId = 'jsonp-loader-' + Date.now();
                const script = document.createElement('script');
                const cacheBust = new Date().getTime();
                script.src = `${SCRIPT_URL}?callback=handleQuizData&cachebust=${cacheBust}`; // Llama a la funci√≥n de carga
                script.id = scriptId;
                script.onerror = handleJSONPError; // Usa el handler de error gen√©rico
                document.body.appendChild(script);
                loadingMessage.textContent = 'Paso 3: Conexi√≥n exitosa. Buscando preguntas...';
                spinnerContainer.classList.add('hidden');
                progressContainer.classList.remove('hidden');
                progressBar.style.width = '50%';
                script.onload = () => { document.getElementById(scriptId)?.remove(); };
            } catch (error) { handleJSONPError(error); }
        }
        
        // --- FIN L√ìGICA DE CARGA Y GUARDADO ---

        /**
         * FUNCI√ìN saveAllQuestionsToSheet (USA FETCH - MANTENIDA POR AHORA)
         * Nota: Si esto tambi√©n da 'Failed to fetch', necesitar√≠amos adaptarlo a JSONP tambi√©n.
         */
        async function saveAllQuestionsToSheet(questionsList) {
            // ... (funci√≥n sin cambios por ahora) ...
             localStorage.setItem('quiz_data_backup', JSON.stringify(questionsList));
            allQuestionsFromSheet = questionsList;
            if (currentMateria) {
                 preguntasMateriaCompleta = allQuestionsFromSheet.filter(q => q.materia === currentMateria);
                 renderGestionPreguntas();
            }
            updateConnectionStatus('connecting');
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', // Google Apps Script puede tener problemas con POST + CORS
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'saveQuestions', data: questionsList })
                });
                if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message || 'Error desconocido al guardar en la nube.');
                console.log("Guardado de preguntas confirmado por Google Sheets.");
                updateConnectionStatus('online');
                setFeedback('¬°√âxito! Guardado en la nube y localmente.', false);
                return true;
            } catch (error) {
                console.error("Error al guardar preguntas en la nube:", error);
                setFeedback(`Advertencia: Fall√≥ el guardado en la nube (${error.message}). Tus cambios est√°n seguros localmente.`, true);
                updateConnectionStatus('offline');
                return false;
            }
        }

        // --- FUNCIONES DE GESTI√ìN (EDITAR/ELIMINAR) ---
        // (Sin cambios significativos)
        function renderGestionPreguntas() { /* ... */ }
        function openEditModal(event) { /* ... */ }
        async function saveEditChanges() { /* ... */ }
        async function deleteQuestion(event) { /* ... */ }
        function setEditFeedback(message, isError = false) { /* ... */ }
        
        // --- FUNCIONES DE UTILIDAD PARA VISTAS ---
        // (Sin cambios significativos)
        function showMateriaSelection() { /* ... */ }
        function selectMateria(materiaId) { /* ... */ }
        function showTemaSelection() { /* ... */ }
        function selectTema(tema) { /* ... */ }
        function alternarVista() { /* ... */ }
        function populateTemaDatalist() { /* ... */ }
        function setFeedback(message, isError = false) { /* ... */ }
        function getUniqueThemes() { /* ... */ }

        // --- INICIO: NUEVAS FUNCIONES PARA AGREGAR MATERIAS (CON GUARDADO JSONP) ---
        function generateMateriaId(name) {
            return name.toLowerCase().trim().replace(/[^a-z0-9-]/g, '').replace(/\s+/g, '-');
        }

        /**
         * Pide nombre y GUARDA usando JSONP (inyectando script)
         */
        function addNewMateria() {
            const materiaName = prompt("Introduce el nombre de la nueva materia:", "Ej: Farmacolog√≠a");
            if (!materiaName || materiaName.trim() === "") return;
            const materiaId = generateMateriaId(materiaName);
            if (MATERIAS[materiaId]) { alert("Error: Ya existe una materia con un nombre similar."); return; }

            const nextColorIndex = Object.keys(MATERIAS).length % MATERIA_COLORS.length;
            const newColor = MATERIA_COLORS[nextColorIndex];

            const newMateriaObject = { id: materiaId, name: materiaName.trim(), color: newColor.color, hover: newColor.hover };

            // Deshabilita bot√≥n
            btnAddMateria.disabled = true;
            btnAddMateria.textContent = "Guardando...";

            // Prepara URL para guardar con JSONP
            const scriptId = 'jsonp-saver-' + Date.now();
            const script = document.createElement('script');
            const dataParam = encodeURIComponent(JSON.stringify(newMateriaObject)); // Codifica el objeto
            
            // Llama a handleSaveResult al terminar
            script.src = `${SCRIPT_URL}?callback=handleSaveResult&action=addMateria&data=${dataParam}`;
            script.id = scriptId;
            script.onerror = handleJSONPError; // Usa el handler gen√©rico

            // Limpia el script tag despu√©s de usarlo (incluso si falla)
            script.onload = script.onerror = () => {
                document.getElementById(scriptId)?.remove();
                // Asegura reactivar el bot√≥n si handleSaveResult no se llam√≥ por alg√∫n error
                if (btnAddMateria.disabled) {
                    btnAddMateria.disabled = false;
                    btnAddMateria.textContent = "+ Agregar Nueva Materia";
                }
            };
            
            // Inyecta el script para enviar la solicitud
            document.body.appendChild(script);
        }
        // --- FIN: NUEVAS FUNCIONES PARA AGREGAR MATERIAS ---

        
        // --- FUNCIONES DE ROBUSTEZ Y API ---
        // (Sin cambios)
        function cleanJsonString(jsonString) { /* ... */ }
        async function fetchWithRetry(url, options, retries = 3) { /* ... */ }
        
        // --- ‚ú® NUEVAS FUNCIONES DE IA (GEMINI API) ‚ú® ---
        // (Sin cambios)
        async function getHint() { /* ... */ }
        async function getELI5Explanation() { /* ... */ }
        async function generateReviewQuestions() { /* ... */ }
        async function verifySingleQuestion(isFromQuiz = false) { /* ... */ }
        async function validateAndRefineQuestions(questions) { /* ... */ }
        async function structurePastedText(rawText, tema) { /* ... */ }
        async function analyzePastedText() { /* ... */ }

        // --- FUNCIONES PRINCIPALES DEL CUESTIONARIO ---
        // (Sin cambios)
        function cargarPregunta() { /* ... */ }
        function seleccionarOpcion(event) { /* ... */ }
        
        // --- MANEJO DE VISTAS DEL EDITOR ---
        // (Sin cambios)
        function shuffleArray(array) { /* ... */ }
        function toggleRandomMode() { /* ... */ }
        function toggleCargaMasiva() { /* ... */ }
        function siguientePregunta() { /* ... */ }
        function mostrarResultados() { /* ... */ }
        function reiniciarCuestionario() { /* ... */ }

        // --- LISTENERS DE EVENTOS ---
        // (Sin cambios, ya incluyen btnAddMateria y btnRandom)
        btnSiguiente.addEventListener('click', siguientePregunta);
        btnReiniciar.addEventListener('click', () => { /* ... */ });
        btnAlternarVista.addEventListener('click', alternarVista);
        // ... (todos los dem√°s listeners) ...
        btnAddMateria.addEventListener('click', addNewMateria);
        btnRandom.addEventListener('click', toggleRandomMode);


        // --- INICIO DE LA APLICACI√ìN ---
      // --- INICIO DE LA APLICACI√ìN (CORREGIDO) ---
// Espera a que el HTML est√© completamente cargado antes de ejecutar CUALQUIER c√≥digo
document.addEventListener('DOMContentLoaded', (event) => {
    console.log('DOM completamente cargado y parseado. Iniciando app...');
    initApp(); // Ahora llamamos a initApp() aqu√≠ dentro
});
        
    </script>
    </body>
</html>


